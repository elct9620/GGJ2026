# Testing Specification

> 版本：0.1.0
> 最後更新：2026-01-31

本文件定義驗證 `SPEC.md` 需求的測試案例。

# 1. Testing Strategy

## 1.1 Test Levels

1. **單元測試（Unit Tests）**：測試個別系統和元件
2. **整合測試（Integration Tests）**：測試系統間互動
3. **驗收測試（Acceptance Tests）**：測試完整遊戲流程

## 1.2 Test Framework

- **框架**：Vitest
- **覆蓋率目標**：80% 以上
- **執行方式**：`npm test`

## 1.3 Test Coverage Goals

| 類別     | 目標覆蓋率 |
| -------- | ---------- |
| 核心系統 | 90%        |
| 遊戲實體 | 85%        |
| UI 元件  | 70%        |
| 整合流程 | 80%        |
| **總體** | **80%**    |

# 2. Unit Tests

## 2.1 Booth System Tests

### 2.1.1 Store Food

| Test ID | Input                        | Expected Output | Accept Criteria        |
| ------- | ---------------------------- | --------------- | ---------------------- |
| BS-01   | 空攤位 + 儲存珍珠            | 攤位數量 = 1    | 攤位顯示珍珠 ×1        |
| BS-02   | 攤位 5/6 + 儲存珍珠          | 攤位數量 = 6    | 攤位顯示珍珠 ×6        |
| BS-03   | 攤位 6/6 + 儲存珍珠          | 攤位數量 = 6    | 儲存失敗，攤位仍為 6/6 |
| BS-04   | 珍珠攤位 + 儲存豆腐          | 儲存失敗        | 豆腐不進入珍珠攤位     |
| BS-05   | 攤位 0/6 + 連續儲存 3 個食材 | 攤位數量 = 3    | 攤位顯示食材 ×3        |
| BS-06   | 3 種攤位同時儲存不同食材     | 各攤位數量 = 1  | 每種食材進入對應攤位   |
| BS-07   | 玩家碰觸掉落食材             | 食材自動拾取    | 食材消失，攤位 +1      |
| BS-08   | 玩家遠離掉落食材             | 無效果          | 食材保持在原位         |

### 2.1.2 Retrieve Food

| Test ID | Input             | Expected Output       | Accept Criteria            |
| ------- | ----------------- | --------------------- | -------------------------- |
| BS-09   | 攤位 3/6 + 按 1   | 攤位 2/6，合成槽 1/3  | 珍珠從攤位移動到合成槽     |
| BS-10   | 攤位 0/6 + 按 1   | 無效果                | 攤位仍為 0/6，合成槽無變化 |
| BS-11   | 合成槽 3/3 + 按 1 | 無效果                | 攤位無變化，合成槽仍為 3/3 |
| BS-12   | 攤位 1/6 + 按 1   | 攤位 0/6，合成槽 1/3  | 提取最後 1 個食材          |
| BS-13   | 連續按 1, 2, 3    | 合成槽 3/3（各 1 個） | 3 種食材進入合成槽         |
| BS-14   | 攤位 6/6 + 按 1   | 攤位 5/6，合成槽 1/3  | 攤位有空位後可再儲存       |

### 2.1.3 Enemy Steal

| Test ID | Input               | Expected Output | Accept Criteria  |
| ------- | ------------------- | --------------- | ---------------- |
| BS-15   | 攤位 3/6 + 敵人觸碰 | 攤位 2/6        | 攤位食材 -1      |
| BS-16   | 攤位 0/6 + 敵人觸碰 | 攤位 0/6        | 無效果           |
| BS-17   | 攤位 6/6 + 敵人觸碰 | 攤位 5/6        | 攤位食材 -1      |
| BS-18   | 敵人觸碰後繼續移動  | 敵人向左移動    | 敵人不停留在攤位 |

## 2.2 Combat System Tests

### 2.2.1 Normal Attack

| Test ID | Input                 | Expected Output        | Accept Criteria    |
| ------- | --------------------- | ---------------------- | ------------------ |
| CS-01   | 彈夾 6/6 + 按 Space   | 彈夾 5/6，子彈生成     | 子彈向右飛行       |
| CS-02   | 彈夾 0/6 + 按 Space   | 無效果                 | 不發射子彈         |
| CS-03   | 子彈擊中餓鬼（1 HP）  | 餓鬼死亡               | 餓鬼消失，掉落食材 |
| CS-04   | 子彈擊中 Boss（3 HP） | Boss 生命 2 HP         | Boss 扣 1 HP       |
| CS-05   | 連續按 Space 6 次     | 彈夾 0/6，6 發子彈生成 | 彈夾歸零           |
| CS-06   | 子彈飛出畫面右邊界    | 子彈消失               | 子彈離開畫面後銷毀 |
| CS-07   | 子彈未擊中任何敵人    | 子彈繼續飛行           | 子彈直到飛出畫面   |

### 2.2.2 Reload

| Test ID | Input                      | Expected Output    | Accept Criteria |
| ------- | -------------------------- | ------------------ | --------------- |
| CS-08   | 彈夾 0/6 + 等待 3 秒       | 彈夾 6/6           | 彈夾恢復滿載    |
| CS-09   | 重裝中（1.5 秒）+ 按 Space | 無效果             | 不發射子彈      |
| CS-10   | 重裝中 + 按 WASD           | 玩家移動           | 玩家正常移動    |
| CS-11   | 彈夾 0/6 + 等待 1.5 秒     | 彈夾 0/6           | 重裝未完成      |
| CS-12   | 重裝完成瞬間 + 按 Space    | 彈夾 5/6，子彈生成 | 可正常射擊      |

### 2.2.3 Special Bullet

| Test ID | Input                         | Expected Output      | Accept Criteria        |
| ------- | ----------------------------- | -------------------- | ---------------------- |
| CS-13   | 臭豆腐 Buff + 按 Space        | 2 倍大子彈，傷害 ×2  | 擊殺 2 HP 敵人         |
| CS-14   | Buff 結束（2 秒後）+ 按 Space | 普通子彈             | 子彈恢復正常大小和傷害 |
| CS-15   | 珍珠奶茶 Buff + 按 Space      | 10 個小子彈          | 同時發射 10 發子彈     |
| CS-16   | 豬血糕 Buff + 子彈擊中敵人    | 子彈不消失，繼續飛行 | 穿透效果               |
| CS-17   | 夜市總匯 + 擊中第 1 隻敵人    | 連鎖擊中後續敵人     | 閃電連鎖直到無敵人     |
| CS-18   | 特殊 Buff 期間 + 按數字鍵     | 無效果               | 無法再次合成           |
| CS-19   | Buff 剩餘 0.5 秒 + 按 Space   | 特殊子彈             | Buff 期間仍有效        |

## 2.3 Synthesis System Tests

### 2.3.1 Decision Table: Synthesis Recipes

| Test ID | 珍珠 | 豆腐 | 米血 | Expected Recipe | Buff Duration | Accept Criteria     |
| ------- | ---- | ---- | ---- | --------------- | ------------- | ------------------- |
| SY-01   | 3    | 0    | 0    | 珍珠奶茶        | 2s            | 散射 10 個小子彈    |
| SY-02   | 0    | 3    | 0    | 臭豆腐          | 2s            | 2 倍大子彈，傷害 ×2 |
| SY-03   | 0    | 0    | 3    | 豬血糕          | 2s            | 穿透子彈，傷害 ×1.2 |
| SY-04   | 1    | 2    | 0    | 臭豆腐奶茶      | 2s            | 散射 3 個巨大子彈   |
| SY-05   | 2    | 1    | 0    | 珍珠臭豆腐      | 2s            | 散射 6 個巨大子彈   |
| SY-06   | 1    | 0    | 2    | 豬血糕奶茶      | 2s            | 散射 3 個穿透子彈   |
| SY-07   | 2    | 0    | 1    | 珍珠豬血糕      | 2s            | 散射 6 個穿透子彈   |
| SY-08   | 0    | 2    | 1    | 臭豬血糕        | 2s            | 1.6 倍穿透巨大子彈  |
| SY-09   | 0    | 1    | 2    | 豬血糕豆腐      | 2s            | 1.2 倍穿透巨大子彈  |
| SY-10   | 1    | 1    | 1    | 夜市總匯        | 即時          | 閃電連鎖            |

### 2.3.2 Insert Food

| Test ID | Input                    | Expected Output    | Accept Criteria        |
| ------- | ------------------------ | ------------------ | ---------------------- |
| SY-11   | 空合成槽 + 按 1          | 合成槽 1/3（珍珠） | 顯示珍珠圖示           |
| SY-12   | 合成槽 2/3 + 按 1        | 自動合成觸發       | 合成槽清空，Buff 啟動  |
| SY-13   | 合成槽 3/3 + 按 1        | 無效果             | 合成槽仍為 3/3         |
| SY-14   | 先按 1, 2, 3（不同順序） | 夜市總匯 Buff      | 順序無關，配方匹配     |
| SY-15   | 合成後立即按 1           | 合成槽 1/3         | 合成槽已清空，可再放入 |

### 2.3.3 Auto Synthesis

| Test ID | Input              | Expected Output | Accept Criteria       |
| ------- | ------------------ | --------------- | --------------------- |
| SY-16   | 放入第 3 個食材    | 立即觸發合成    | 合成槽清空，Buff 啟動 |
| SY-17   | 合成觸發時攤位食材 | 攤位食材 -3     | 消耗對應食材          |
| SY-18   | 合成成功後合成槽   | 合成槽 0/3      | 槽位歸零              |

## 2.4 Upgrade System Tests

### 2.4.1 Decision Table: Upgrade Availability

| Test ID | 豆腐庫存 | 珍珠庫存 | 米血庫存 | 升級選項 | Available | Accept Criteria |
| ------- | -------- | -------- | -------- | -------- | --------- | --------------- |
| UP-01   | 3        | 0        | 0        | 加辣     | ✓         | 可選擇          |
| UP-02   | 2        | 0        | 0        | 加辣     | ✗         | 顯示為不可選    |
| UP-03   | 0        | 3        | 0        | 加椰果   | ✓         | 可選擇          |
| UP-04   | 0        | 2        | 0        | 加椰果   | ✗         | 顯示為不可選    |
| UP-05   | 0        | 0        | 3        | 加香菜   | ✓         | 可選擇          |
| UP-06   | 0        | 0        | 2        | 加香菜   | ✗         | 顯示為不可選    |
| UP-07   | 6        | 6        | 6        | 任一     | ✓         | 所有升級可選    |
| UP-08   | 0        | 0        | 0        | 任一     | ✗         | 所有升級不可選  |

### 2.4.2 Present Options

| Test ID | Input        | Expected Output    | Accept Criteria |
| ------- | ------------ | ------------------ | --------------- |
| UP-09   | 回合結束     | 顯示 2 個升級選項  | 隨機抽取        |
| UP-10   | 多次回合結束 | 選項組合不全相同   | 隨機性          |
| UP-11   | 升級選項顯示 | 包含效果和消耗說明 | UI 顯示完整資訊 |

### 2.4.3 Apply Upgrade

| Test ID | Input                      | Expected Output                | Accept Criteria    |
| ------- | -------------------------- | ------------------------------ | ------------------ |
| UP-12   | 豆腐 3/6 + 選擇「加辣」    | 豆腐 0/6，臭豆腐傷害倍率 +0.5  | 消耗食材，效果套用 |
| UP-13   | 已選「加辣」+ 再選「加辣」 | 臭豆腐傷害倍率再 +0.5          | 效果堆疊           |
| UP-14   | 第 2 回合選「加辣」        | 第 5 回合臭豆腐傷害倍率仍 +0.5 | 永久效果           |
| UP-15   | 未選擇任何選項             | 無法進入下一回合               | 必須選擇升級       |
| UP-16   | 選擇升級後                 | 進入下一回合                   | 回合數 +1          |

## 2.5 Wave System Tests

### 2.5.1 Decision Table: Enemy Spawning

| Test ID | 回合數 | 一般敵人數 | Boss 數 | 總敵人數 | Accept Criteria      |
| ------- | ------ | ---------- | ------- | -------- | -------------------- |
| WS-01   | 1      | 2          | 0       | 2        | 公式：回合數 × 2     |
| WS-02   | 2      | 4          | 0       | 4        | 公式：回合數 × 2     |
| WS-03   | 5      | 10         | 1       | 11       | Boss 每 5 回合出現   |
| WS-04   | 10     | 20         | 1       | 21       | Boss 每 5 回合出現   |
| WS-05   | 15     | 30         | 1       | 31       | Boss 每 5 回合出現   |
| WS-06   | 6      | 12         | 0       | 12       | 非 5 倍數回合無 Boss |
| WS-07   | 25     | 50         | 1       | 51       | 最大敵人數測試       |

### 2.5.2 Wave Progression

| Test ID | Input             | Expected Output | Accept Criteria        |
| ------- | ----------------- | --------------- | ---------------------- |
| WS-08   | 擊敗最後 1 隻敵人 | 觸發升級畫面    | 回合結束               |
| WS-09   | 升級完成          | 進入下一回合    | 回合數 +1，生成新敵人  |
| WS-10   | 玩家生命值 = 0    | 遊戲結束        | 不進入下一回合         |
| WS-11   | 所有敵人到達底線  | 觸發升級畫面    | 敵人清空（即使未擊殺） |

## 2.6 Player Tests

### 2.6.1 Movement

| Test ID | Input                       | Expected Output  | Accept Criteria |
| ------- | --------------------------- | ---------------- | --------------- |
| PL-01   | 玩家 (500, 500) + 按 W 1 秒 | 玩家 (500, 300)  | 向上移動 200 px |
| PL-02   | 玩家 (500, 500) + 按 A 1 秒 | 玩家 (300, 500)  | 向左移動 200 px |
| PL-03   | 玩家 (500, 500) + 按 S 1 秒 | 玩家 (500, 700)  | 向下移動 200 px |
| PL-04   | 玩家 (500, 500) + 按 D 1 秒 | 玩家 (700, 500)  | 向右移動 200 px |
| PL-05   | 玩家 (384, 500) + 按 A      | 玩家 (384, 500)  | 碰到左邊界停止  |
| PL-06   | 玩家 (1920, 500) + 按 D     | 玩家 (1920, 500) | 碰到右邊界停止  |
| PL-07   | 玩家 (500, 0) + 按 W        | 玩家 (500, 0)    | 碰到上邊界停止  |
| PL-08   | 玩家 (500, 1080) + 按 S     | 玩家 (500, 1080) | 碰到下邊界停止  |
| PL-09   | 同時按 W + D                | 玩家向右上移動   | 對角線移動      |

### 2.6.2 Collision

| Test ID | Input                                 | Expected Output   | Accept Criteria   |
| ------- | ------------------------------------- | ----------------- | ----------------- |
| PL-10   | 玩家 (500, 500) + 食材 (500, 500)     | 食材消失，攤位 +1 | 自動拾取          |
| PL-11   | 玩家中心 (500, 500) + 敵人 (512, 500) | 無碰撞            | 距離 > 24，無效果 |
| PL-12   | 玩家中心 (500, 500) + 敵人 (510, 500) | 無碰撞（穿透）    | 玩家不受傷        |
| PL-13   | 碰撞箱測試                            | 24×24 px          | 碰撞箱大小正確    |

### 2.6.3 Health

| Test ID | Input                 | Expected Output  | Accept Criteria  |
| ------- | --------------------- | ---------------- | ---------------- |
| PL-14   | 生命 5 + 敵人到達底線 | 生命 4           | 扣 1 條生命      |
| PL-15   | 生命 1 + 敵人到達底線 | 生命 0，遊戲結束 | 觸發遊戲結束畫面 |
| PL-16   | 遊戲結束畫面          | 顯示存活回合數   | 統計資訊正確     |

## 2.7 Enemy Tests

### 2.7.1 Ghost (餓鬼)

| Test ID | Input                    | Expected Output       | Accept Criteria    |
| ------- | ------------------------ | --------------------- | ------------------ |
| EN-01   | 餓鬼 (1000, 500) + 1 秒  | 餓鬼 (950, 500)       | 向左移動 50 px     |
| EN-02   | 餓鬼 1 HP + 普通子彈擊中 | 餓鬼死亡              | 餓鬼消失           |
| EN-03   | 餓鬼死亡                 | 掉落隨機食材          | 珍珠/豆腐/米血其一 |
| EN-04   | 餓鬼死亡位置 (500, 500)  | 食材生成 (500, 500)   | 食材在死亡位置     |
| EN-05   | 餓鬼到達 x = 384         | 玩家生命 -1，餓鬼消失 | 到達底線           |

### 2.7.2 Boss (餓死鬼)

| Test ID | Input                    | Expected Output        | Accept Criteria    |
| ------- | ------------------------ | ---------------------- | ------------------ |
| EN-06   | Boss (1000, 500) + 1 秒  | Boss (970, 500)        | 向左移動 30 px     |
| EN-07   | Boss 3 HP + 普通子彈擊中 | Boss 2 HP              | 扣 1 HP            |
| EN-08   | Boss 3 HP + 3 發普通子彈 | Boss 死亡              | 3 次攻擊擊殺       |
| EN-09   | Boss 到達 x = 384        | 玩家生命 -1，Boss 消失 | 到達底線           |
| EN-10   | Boss 死亡                | 掉落隨機食材           | 珍珠/豆腐/米血其一 |

### 2.7.3 Booth Interaction

| Test ID | Input               | Expected Output  | Accept Criteria |
| ------- | ------------------- | ---------------- | --------------- |
| EN-11   | 攤位 3/6 + 敵人觸碰 | 攤位 2/6         | 偷取 1 個食材   |
| EN-12   | 敵人偷取後          | 敵人繼續向左移動 | 不停留在攤位    |
| EN-13   | 攤位 0/6 + 敵人觸碰 | 攤位 0/6         | 無食材可偷      |

# 3. Integration Tests

## 3.1 Gameplay Loop

| Test ID | Scenario               | Steps                                                 | Expected Outcome | Accept Criteria         |
| ------- | ---------------------- | ----------------------------------------------------- | ---------------- | ----------------------- |
| IT-01   | 完整回合               | 1. 擊敗所有敵人<br>2. 拾取食材<br>3. 選擇升級         | 進入第 2 回合    | 回合數 +1               |
| IT-02   | 合成 → 射擊流程        | 1. 按 2, 2, 2 提取豆腐<br>2. 自動合成<br>3. 按 Space  | 發射 2 倍大子彈  | 臭豆腐 Buff 生效        |
| IT-03   | 升級 → 效果生效        | 1. 選擇「加辣」<br>2. 下回合合成臭豆腐<br>3. 射擊敵人 | 傷害 = ×2.5      | 升級效果永久套用        |
| IT-04   | 完整遊戲流程（5 回合） | 1. 完成 5 個回合<br>2. 面對 Boss                      | 存活至回合 5     | Boss 出現，遊戲持續運行 |

## 3.2 System Interactions

| Test ID | System A | System B | Interaction        | Expected Outcome         | Accept Criteria |
| ------- | -------- | -------- | ------------------ | ------------------------ | --------------- |
| IT-05   | 攤位系統 | 合成系統 | 提取珍珠到合成槽   | 攤位 -1，合成槽 +1       | 數據正確傳遞    |
| IT-06   | 戰鬥系統 | 合成系統 | 檢查當前 Buff 狀態 | 返回 Buff 類型和剩餘時間 | Buff 狀態正確   |
| IT-07   | 回合系統 | 升級系統 | 回合結束觸發升級   | 升級系統顯示選項         | 觸發機制正常    |
| IT-08   | 敵人系統 | 攤位系統 | 敵人請求偷取食材   | 攤位系統扣除 1 個食材    | 系統間通訊正常  |

# 4. Acceptance Tests

## 4.1 User Stories

| Test ID | User Story            | Scenario                                                                  | Expected Result      | Accept Criteria          |
| ------- | --------------------- | ------------------------------------------------------------------------- | -------------------- | ------------------------ |
| AT-01   | 新手玩家第一次遊玩    | 1. 按 Space 射擊餓鬼<br>2. 拾取珍珠<br>3. 合成珍珠奶茶<br>4. 發射散射子彈 | 特殊子彈擊中多隻敵人 | 遊戲機制直觀易懂         |
| AT-02   | 進階玩家存活 10 回合  | 1. 完成 10 個回合<br>2. 策略性使用升級和合成                              | 玩家仍有生命值       | 第 10 回合生成 21 隻敵人 |
| AT-03   | Boss 回合使用夜市總匯 | 1. 第 5 回合開始<br>2. 合成夜市總匯<br>3. 射擊 Boss                       | 閃電連鎖擊中所有敵人 | 夜市總匯效果正確         |

## 4.2 Game End Conditions

| Test ID | Condition      | Input                   | Expected Output        | Accept Criteria                        |
| ------- | -------------- | ----------------------- | ---------------------- | -------------------------------------- |
| AT-04   | 玩家生命值歸零 | 生命 1 + 敵人到達底線   | 遊戲暫停，顯示結算畫面 | 顯示存活回合數、擊敗敵人數             |
| AT-05   | 遊戲結束統計   | 遊戲結束畫面            | 顯示統計資訊           | 存活回合數、擊敗敵人、使用特殊子彈次數 |
| AT-06   | 重新開始       | 結算畫面 + 選擇重新開始 | 回到第 1 回合          | 所有狀態重置                           |

# 5. Performance Tests

## 5.1 Frame Rate

| Test ID | Scenario                       | Load Condition     | Expected FPS | Accept Criteria  |
| ------- | ------------------------------ | ------------------ | ------------ | ---------------- |
| PT-01   | 50 隻敵人同時存在              | 第 25 回合         | ≥ 55 FPS     | 平均幀率穩定     |
| PT-02   | 100 發子彈同時存在             | 散射類子彈大量發射 | ≥ 55 FPS     | 平均幀率穩定     |
| PT-03   | 複雜場景（50 敵人 + 100 子彈） | 極限測試           | ≥ 50 FPS     | 可接受的效能下限 |

## 5.2 Memory Usage

| Test ID | Scenario     | Duration       | Expected Memory Usage | Accept Criteria |
| ------- | ------------ | -------------- | --------------------- | --------------- |
| PT-04   | 長時間遊戲   | 30 分鐘        | 記憶體增長 < 50 MB    | 無記憶體洩漏    |
| PT-05   | 多次重新開始 | 重新開始 10 次 | 記憶體穩定            | 資源正確釋放    |

# 6. Browser Compatibility Tests

## 6.1 Cross-Browser

| Test ID | Browser | Version | Expected Result | Accept Criteria |
| ------- | ------- | ------- | --------------- | --------------- |
| BC-01   | Chrome  | 120+    | 所有功能正常    | 無錯誤，60 FPS  |
| BC-02   | Firefox | 120+    | 所有功能正常    | 無錯誤，60 FPS  |
| BC-03   | Safari  | 17+     | 所有功能正常    | 無錯誤，60 FPS  |
| BC-04   | Edge    | 120+    | 所有功能正常    | 無錯誤，60 FPS  |

# 7. Manual Testing Checklist

## 7.1 Visual Quality

- [ ] 攤位區域正確顯示在左側 20%
- [ ] HUD 不遮蓋遊戲活動區域
- [ ] 敵人生成和移動動畫流暢
- [ ] 子彈發射方向正確（向右）
- [ ] 食材掉落位置合理（敵人死亡處）
- [ ] 特殊子彈效果可視化清晰
- [ ] Pixi.js Sprite 渲染正確
- [ ] 碰撞箱大小視覺化準確

## 7.2 Audio Quality

- [ ] 射擊音效正確觸發
- [ ] 敵人死亡音效播放
- [ ] 合成成功音效提示
- [ ] 背景音樂循環播放
- [ ] Boss 出現特殊音效

## 7.3 User Experience

- [ ] 鍵盤操作反應靈敏（延遲 < 100ms）
- [ ] 合成槽視覺回饋清晰
- [ ] 升級選項說明易懂
- [ ] 遊戲結束畫面統計準確
- [ ] 重新開始功能正常
- [ ] 載入時間 < 3 秒

# 8. Continuous Integration

## 8.1 CI Pipeline

1. **Lint**：程式碼風格檢查（Prettier + ESLint）
2. **Type Check**：TypeScript 型別檢查
3. **Unit Tests**：單元測試（Vitest）
4. **Integration Tests**：整合測試
5. **Build**：編譯打包（Vite）
6. **Deploy Preview**：部署預覽環境（Cloudflare Pages）

## 8.2 Quality Gates

| Gate            | Requirement | Accept Criteria  |
| --------------- | ----------- | ---------------- |
| 測試通過率      | 100%        | 所有測試必須通過 |
| 程式碼覆蓋率    | ≥ 80%       | 總體覆蓋率達標   |
| TypeScript 錯誤 | 0           | 無型別錯誤       |
| Lint 錯誤       | 0           | 無程式碼風格錯誤 |
| 建置成功        | ✓           | 建置無錯誤       |
