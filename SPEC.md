# Game Specification: Night Market Defense

# 1. Intent Layer

## 1.1 Purpose

本遊戲為 Global Game Jam 2026 參賽作品，主題為「Mask」。透過橫向類塔防遊戲機制，讓玩家體驗台灣夜市攤位文化與餓鬼傳說的結合。

**核心價值主張**：

- 快節奏的戰鬥與資源管理結合
- 台灣夜市特色食材合成系統
- 策略性的攤位防守與升級選擇

## 1.2 Users

**主要使用者**：

- 團隊成員和朋友
- Game Jam 評審和參與者
- 休閒遊戲玩家

**使用情境**：

- 單人遊戲體驗
- 瀏覽器環境（Cloudflare 部署）
- 短時間遊戲場次（5-15 分鐘）

## 1.3 Success Criteria

**可衡量指標**：

1. **完成度**：所有核心系統可運作
   - 攤位系統可儲存和提取食材
   - 戰鬥系統可射擊和擊敗敵人
   - 合成系統可產生特殊子彈
   - 升級系統可強化能力

2. **遊戲平衡**：
   - 玩家可存活至少 5 個回合
   - 進階玩家可達成 10 個回合以上
   - 每個回合有明確的挑戰增長

3. **主題符合度**：
   - 遊戲機制呼應「Mask」主題（覆蓋、防守）
   - 視覺和音效完整呈現

4. **技術品質**：
   - 在現代瀏覽器流暢運行（60 FPS）
   - 無重大錯誤和崩潰

# 2. Design Layer

## 2.1 Game Overview

**核心概念**：玩家操作角色在夜市攤位區防守，透過射擊餓鬼、收集食材、合成特殊子彈，在無盡回合中盡可能存活。

**遊戲循環**：

1. 敵人從右側生成並向左移動
2. 玩家射擊敵人獲取食材
3. 收集食材到攤位儲存
4. 合成特殊子彈強化攻擊
5. 回合結束後選擇升級
6. 敵人數量增加，難度提升

## 2.2 Terminology

| 術語                         | 定義                                                                       |
| ---------------------------- | -------------------------------------------------------------------------- |
| **Entity（實體）**           | 遊戲中所有物件的基礎類別，提供唯一 ID 和生命週期管理                       |
| **Player（玩家）**           | 可操作的角色，能在遊戲畫面中自由移動                                       |
| **Booth（攤位）**            | 用來儲存食材的固定區域，每種食材有專屬攤位                                 |
| **Food（食材）**             | 合成技能的素材，擊敗敵人掉落，敵人也會奪取                                 |
| **Ghost（餓鬼）**            | 小怪，基礎生命值 1 點，不掉落食材                                          |
| **Elite（菁英）**            | 彩色餓鬼（紅/綠/藍），基礎生命值 2 點，100% 掉落對應食材                   |
| **Red Ghost（紅惡鬼）**      | 菁英敵人，基礎生命值 2 點，100% 掉落豆腐                                   |
| **Green Ghost（綠惡鬼）**    | 菁英敵人，基礎生命值 2 點，100% 掉落珍珠                                   |
| **Blue Ghost（藍惡鬼）**     | 菁英敵人，基礎生命值 2 點，100% 掉落米血                                   |
| **Boss（餓死鬼）**           | Boss 敵人，基礎生命值 10 點，每 5 回合出現，擊敗後提供特殊升級             |
| **Wave（回合）**             | 每回合生成固定數量敵人，回合數越高敵人越多                                 |
| **Bullet（子彈）**           | 玩家攻擊單位，包含普通子彈和特殊子彈                                       |
| **Synthesis（合成）**        | 消耗食材產生特殊子彈效果                                                   |
| **Upgrade（升級）**          | 回合間強化能力的永久效果                                                   |
| **Box（寶箱）**              | 出現在攤位前方的防禦機制，用食材數量阻擋敵人，敵人碰撞時消耗食材並消除敵人 |
| **Kill Counter（擊殺計數）** | 追踪玩家擊殺敵人數量的系統，用於遊戲統計和結算畫面                         |
| **Vector（向量）**           | 不可變的 2D 座標值物件，用於位置和方向計算                                 |
| **Event（事件）**            | 遊戲中發生的狀態變更通知，包含類型和可選資料                               |
| **EventQueue（事件佇列）**   | 管理和調度遊戲事件的系統，統一處理延遲執行                                 |

## 2.3 Core Systems

### 2.3.1 Booth System

**Purpose**: 儲存食材供合成使用

**Constraints**:

- 固定 3 個攤位位置（遊戲開始時已設置，攤位不可移動）
- 每個攤位對應一種食材類型
- 每個攤位可儲存 6 個食材（6 slots）
- 敵人每次觸碰攤位僅偷取 1 個食材

**Behaviors**:

- **Store（儲存）**: 敵人死亡掉落食材後，食材自動進入對應攤位（無需玩家拾取）
- **Consume（消耗）**: 合成系統按鍵觸發時直接消耗攤位食材
- **Enemy Steal（敵人奪取）**: 敵人觸碰攤位時偷取 1 個食材

**Booth System Decision Table**:

| 食材數 | 動作     | 結果     | 事後狀態 |
| ------ | -------- | -------- | -------- |
| 6/6    | 儲存     | 食材消失 | 6/6      |
| 0-5    | 儲存     | 成功     | +1       |
| 0/6    | 消耗     | 失敗     | 0/6      |
| 1-6    | 消耗     | 成功     | -1       |
| 0/6    | 敵人偷取 | 無效果   | 0/6      |
| 1-6    | 敵人偷取 | -1 食材  | -1       |

**Food Types**:

| 食材名稱 | 攤位編號 | 最大儲存量 |
| -------- | -------- | ---------- |
| 珍珠     | 1        | 6          |
| 豆腐     | 2        | 6          |
| 米血     | 3        | 6          |

### 2.3.2 Combat System

**Purpose**: 玩家透過射擊擊敗敵人

**Constraints**:

- 彈夾容量：6 發子彈
- 重裝時間：3 秒
- 普通子彈傷害：1 點（擊殺 1 隻餓鬼，對 Boss 造成 1 點傷害）
- 特殊子彈持續時間：2 秒（夜市總匯除外）
- 重裝期間：玩家可移動但無法射擊
- 特殊子彈為臨時 Buff：不替換彈夾內容，僅在 Buff 期間強化發射的子彈

**Behaviors**:

- **Normal Attack（普通攻擊）**:
  - 按下 Space 鍵發射子彈
  - 子彈向右直線飛行
  - 擊中敵人造成傷害
  - 消耗彈夾數量（6 → 5 → ... → 0）

- **Reload（重裝）**:
  - 彈夾歸零時自動觸發
  - 3 秒後彈夾恢復至 6 發
  - 重裝期間玩家可移動但無法射擊

- **Special Bullet（特殊子彈）**:
  - 合成成功後立即啟動 2 秒 Buff
  - Buff 期間發射的子彈擁有特殊效果
  - Buff 結束後恢復普通子彈

**Combat System Decision Table**:

| 彈藥 | 重裝中 | Buff | 輸入  | 結果          |
| ---- | ------ | ---- | ----- | ------------- |
| >0   | 否     | 任何 | Space | 發射，彈藥 -1 |
| 0    | 否     | 任何 | Space | 無效果        |
| 任何 | 是     | 任何 | Space | 無效果        |
| 任何 | 任何   | 無   | 1-5   | 嘗試合成      |
| 任何 | 任何   | 有   | 1-5   | 無效果        |

### 2.3.3 Synthesis System

**Purpose**: 透過按鍵快速發動特殊子彈效果（即時消耗食材）

**Constraints**:

- 按鍵 1-5 分別對應 5 種特殊子彈
- 直接從攤位消耗食材
- 特殊子彈不能堆疊：Buff 期間無法再次觸發
- Buff 持續時間：2 秒（所有特殊子彈統一）

**Behaviors**:

- **Trigger by Key（按鍵觸發）**:
  - 按下數字鍵 1-5 檢查食材是否滿足配方
  - 食材充足時立即消耗並啟動 Buff
  - Buff 期間發射的子彈擁有特殊效果

- **Consume Food（消耗食材）**:
  - 直接從攤位扣除對應食材
  - 消耗後攤位食材數量減少

- **Activate Buff（啟動 Buff）**:
  - 接下來發射的子彈擁有特殊效果（2 秒內）
  - UI 顯示當前 Buff 類型和剩餘時間

- **Buff Expiration（Buff 結束）**:
  - 2 秒後 Buff 結束
  - 恢復普通子彈

**Synthesis Recipes Decision Table**:

| 按鍵 | 名稱     | 消耗                 | 基礎傷害                              | 效果                       | 時長 |
| ---- | -------- | -------------------- | ------------------------------------- | -------------------------- | ---- |
| 預設 | 普通     | 無                   | 1                                     | 無                         | 無   |
| 1    | 夜市總匯 | 豆腐×1,珍珠×1,米血×1 | 2                                     | 連鎖 5 目標，-20%/命中衰減 | 2s   |
| 2    | 臭豆腐   | 豆腐×3               | 2                                     | 貫穿 1 敵人                | 2s   |
| 3    | 珍珠奶茶 | 珍珠×3               | 1                                     | 三向散射，+1 子彈          | 2s   |
| 4    | 豬血糕   | 米血×3               | 2                                     | 追蹤，命中-10%敵人移速     | 2s   |
| 5    | 蚵仔煎   | 20 擊殺數            | Boss:10% HP, 菁英:50% HP, 小怪:70% HP | 百分比傷害                 | 單發 |

**配方說明**:

- 蚵仔煎為特殊子彈，消耗擊殺數而非食材
- 每次使用消耗 20 個擊殺數（從 Kill Counter 扣除）
- 蚵仔煎為百分比傷害：Boss 造成當前血量 10%，菁英怪 50%，小怪 70%
- 快吃升級可使蚵仔煎傷害 +10%
- 其他特殊子彈按鍵觸發時立即檢查並消耗食材

**Error Scenarios Decision Table**:

| 珍珠   | 豆腐 | 米血 | 擊殺 | Buff | 按鍵 | 結果         |
| ------ | ---- | ---- | ---- | ---- | ---- | ------------ |
| ≥1     | ≥1   | ≥1   | 任何 | 無   | 1    | 夜市總匯成功 |
| 任一<1 | -    | -    | 任何 | 無   | 1    | 失敗，提示   |
| 任何   | ≥3   | 任何 | 任何 | 無   | 2    | 臭豆腐成功   |
| 任何   | <3   | 任何 | 任何 | 無   | 2    | 失敗，提示   |
| ≥3     | 任何 | 任何 | 任何 | 無   | 3    | 珍珠奶茶成功 |
| <3     | 任何 | 任何 | 任何 | 無   | 3    | 失敗，提示   |
| 任何   | 任何 | ≥3   | 任何 | 無   | 4    | 豬血糕成功   |
| 任何   | 任何 | <3   | 任何 | 無   | 4    | 失敗，提示   |
| 任何   | 任何 | 任何 | ≥20  | 無   | 5    | 蚵仔煎成功   |
| 任何   | 任何 | 任何 | <20  | 無   | 5    | 失敗，提示   |
| 任何   | 任何 | 任何 | 任何 | 有   | 1-5  | 無效果       |

### 2.3.4 Upgrade System

**Purpose**: 回合間及 Boss 擊敗後永久強化玩家能力

**Constraints**:

- 每波結束提供 2 個隨機選項
- 非 Boss 波：從普通升級池抽取（無消耗，直接選擇）
- Boss 波（5, 10, 15...）：從 Boss 升級池抽取（無消耗，直接選擇）
- 玩家選擇其中 1 個
- 升級效果永久持續（整場遊戲，不會因回合結束而重置）
- 同一升級可重複選擇（效果堆疊，無上限）

**Behaviors**:

- **Present Options（呈現選項）**:
  - 回合結束觸發
  - 根據波次類型（普通/Boss）選擇升級池
  - 隨機抽取 2 個升級選項
  - 顯示升級效果（無需消耗）

- **Apply Upgrade（套用升級）**:
  - 玩家選擇升級
  - 永久修改遊戲參數
  - 進入下一回合

**Error Scenarios**:

| 操作         | 條件           | 結果             |
| ------------ | -------------- | ---------------- |
| 進入下一回合 | 未選擇任何選項 | 無法進入下一回合 |

**Normal Upgrade Decision Table（普通升級）**:

| 升級   | 效果                | 堆疊方式 | 上限 |
| ------ | ------------------- | -------- | ---- |
| 加辣   | 臭豆腐傷害 +0.5     | 加法     | 無限 |
| 加椰果 | 珍珠奶茶子彈 **+1** | 加法     | 無限 |
| 加香菜 | 豬血糕範圍 +0.5     | 加法     | 無限 |

**Boss Upgrade Decision Table（Boss 升級）**:

| 升級       | 效果                          | 堆疊方式 | 最大次數 |
| ---------- | ----------------------------- | -------- | -------- |
| 打折       | 三種子彈消耗 -1               | 加法     | 1        |
| 大胃王     | 彈匣容量 **+6**               | 加法     | 3        |
| 快吃       | 蚵仔煎 **+10% 傷害**          | 加法     | 1        |
| 飢餓三十   | Buff 時長 **+2s**             | 加法     | 4        |
| 總匯吃到飽 | 夜市總匯鏈結 ×2，衰減 -10%/人 | 乘法     | 2        |
| 好餓好餓   | 換彈時間 -0.5s                | 加法     | 3        |

**Boss 升級選擇機制**:

- 每種升級最多出現一次（直到達到次數上限後從池中移除）
- 每次從剩餘池中隨機選 2 個，玩家選 1 個

**升級效果說明**:

- 打折：永久減少食材消耗（3→2），最低 1，僅可選擇 1 次
- 大胃王：彈匣容量 +6（6→12→18→24），最多 3 次
- 快吃：蚵仔煎百分比傷害額外 +10%，僅可選擇 1 次
- 飢餓三十：特殊子彈 Buff 時間 +2s（2s→4s→6s→8s→10s），最多 4 次
- 總匯吃到飽：夜市總匯鏈結目標 ×2，傷害衰減 -10%/人，最多 2 次
- 好餓好餓：換彈時間 -0.5s（3s→2.5s→2s→1.5s），最多 3 次

### 2.3.5 Wave System

**Purpose**: 控制敵人生成和回合進程

**Constraints**:

- 無限回合（直到玩家死亡，無勝利條件）
- 敵人數量線性增長：回合數 × 2（第 1 回合 2 隻，第 2 回合 4 隻，依此類推）
- Boss 每 5 回合出現一次（第 5, 10, 15... 回合）

**Behaviors**:

- **Spawn Enemies（生成敵人）**:
  - 回合開始時計算敵人數量
  - 一般敵人數 = 回合數 × 2
  - Boss 回合（5, 10, 15...）額外生成 1 隻 Boss

- **Wave Progression（回合進程）**:
  - 所有敵人被擊敗或到達底線
  - 觸發升級選擇
  - 升級完成後進入下一回合

**Error Scenarios**:

| 條件           | 結果                     |
| -------------- | ------------------------ |
| 玩家生命值歸零 | 遊戲結束，不進入下一回合 |

**Spawn Probability（生成機率）**:

| 敵人類型 | 生成機率 | 備註                   |
| -------- | -------- | ---------------------- |
| 餓鬼     | 40%      | 基礎敵人，掉落隨機食材 |
| 紅惡鬼   | 20%      | 固定掉豆腐             |
| 綠惡鬼   | 20%      | 固定掉珍珠             |
| 藍惡鬼   | 20%      | 固定掉米血             |

**Spawn Frequency（生成頻率）**:

- 基礎間隔：2~3 秒（隨機）
- 間隔不隨波次縮短（維持固定節奏）
- 停止條件：該波所有敵人已生成完畢

**Spawn Position（生成位置）**:

- X 座標：1950 px（畫面右側外 30px）
- Y 座標：隨機 214~826 px（遊戲區域內，考慮敵人大小 256px，確保整個敵人可見）
- 生成順序：逐個生成，不同時生成多隻

**Boss Spawn（Boss 生成）**:

- 頻率：每 5 波出現一次（波次 5, 10, 15...）
- 位置：同普通敵人（x = 1950, y = 隨機）
- 順序：該波最後一隻敵人生成
- Boss 不計入生成機率（額外生成）

**Wave Formula**:

| 回合數 | 一般敵人數 | Boss 數 | 總敵人數 |
| ------ | ---------- | ------- | -------- |
| 1      | 2          | 0       | 2        |
| 2      | 4          | 0       | 4        |
| 3      | 6          | 0       | 6        |
| 4      | 8          | 0       | 8        |
| 5      | 10         | 1       | 11       |
| 10     | 20         | 1       | 21       |
| 15     | 30         | 1       | 31       |

### 2.3.6 EventQueue System

**Purpose**: 統一管理遊戲事件和延遲執行，替代散落的 `setTimeout` 呼叫，讓各系統透過事件驅動方式互動。

**Constraints**:

- 事件佇列為單例（Singleton），全域唯一實例
- 事件按照發佈順序和延遲時間依序執行
- 每個事件類型可有多個訂閱者（Subscriber）
- 訂閱者必須提供處理函式（Handler）
- 支援延遲執行（Delayed Execution），單位為毫秒（ms）

**Behaviors**:

- **Publish Event（發佈事件）**:
  - 系統調用 `publish(eventType, data?, delay?)` 發佈事件
  - 若無延遲（`delay = 0` 或未指定），立即通知所有訂閱者
  - 若有延遲（`delay > 0`），加入延遲佇列，等待指定時間後執行

- **Subscribe（訂閱事件）**:
  - 系統調用 `subscribe(eventType, handler)` 訂閱事件類型
  - 當事件發佈時，所有訂閱者的 `handler` 函式被調用
  - 訂閱者可訂閱多個事件類型

- **Unsubscribe（取消訂閱）**:
  - 系統調用 `unsubscribe(eventType, handler)` 取消訂閱
  - 取消後不再接收該事件類型的通知

- **Process Queue（處理佇列）**:
  - 每個遊戲幀（Game Loop Tick）檢查延遲佇列
  - 若事件到達執行時間，從佇列移除並通知訂閱者
  - 事件按照到達執行時間排序（最早到達的先執行）

**Error Scenarios**:

| 操作             | 當前狀態               | 結果                         |
| ---------------- | ---------------------- | ---------------------------- |
| 發佈事件         | 無訂閱者               | 事件被丟棄（無錯誤）         |
| 訂閱事件         | 重複訂閱同一處理函式   | 僅保留一個訂閱（去重）       |
| 取消訂閱         | 處理函式不存在         | 無效果                       |
| 處理延遲事件     | 延遲時間為負數         | 視為立即執行（delay=0）      |
| Handler 拋出錯誤 | 訂閱者處理函式執行失敗 | 記錄錯誤，繼續執行其他訂閱者 |

**Event Types**:

遊戲中定義的事件類型：

| 事件類型             | 資料結構                                | 發佈時機                     | 訂閱系統                                  |
| -------------------- | --------------------------------------- | ---------------------------- | ----------------------------------------- |
| `WaveComplete`       | `{ waveNumber: number }`                | 回合內所有敵人清除           | Wave System                               |
| `WaveStart`          | `{ waveNumber: number }`                | 新回合開始                   | Wave System, UI                           |
| `UpgradeSelected`    | `{ upgradeId: string }`                 | 玩家選擇升級                 | Upgrade System                            |
| `ReloadComplete`     | `{}`                                    | 彈夾重裝完成（3 秒後）       | Combat System                             |
| `SynthesisTriggered` | `{ recipeId: string }`                  | 按鍵 1-5 觸發特殊子彈        | Synthesis System                          |
| `BuffExpired`        | `{ buffType: string }`                  | 特殊子彈 Buff 結束（2 秒後） | Combat System                             |
| `EnemyDeath`         | `{ enemyId: string, position: Vector }` | 敵人生命值歸零               | Combat System, Booth System, Kill Counter |
| `EnemyReachedEnd`    | `{ enemyId: string }`                   | 敵人到達底線                 | Wave System, Player                       |
| `PlayerDeath`        | `{}`                                    | 玩家生命值歸零               | Game Scene                                |
| `FoodStored`         | `{ boothId: string, foodType: string }` | 食材進入攤位                 | Box System                                |
| `FoodConsumed`       | `{ boothId: string, amount: number }`   | 攤位食材被消耗               | Box System                                |

**Integration with Systems**:

各系統使用 EventQueue 的方式：

- **Wave System**:
  - 發佈 `WaveStart` 事件（回合開始）
  - 訂閱 `EnemyReachedEnd` 和 `EnemyDeath` 事件（追蹤敵人數量）
  - 發佈 `WaveComplete` 事件（延遲觸發，用於回合轉換）

- **Combat System**:
  - 發佈 `ReloadComplete` 事件（延遲 3000ms）
  - 訂閱 `SynthesisTriggered` 事件（啟動特殊子彈 Buff）
  - 發佈 `BuffExpired` 事件（延遲 2000ms）

- **Synthesis System**:
  - 發佈 `SynthesisTriggered` 事件（按鍵 1-5 觸發時）

- **Booth System**:
  - 訂閱 `EnemyDeath` 事件（自動儲存掉落食材）

**測試案例**：參見 [docs/testing.md](docs/testing.md) § 2.9 EventQueue Tests。

### 2.3.7 Box System (Booth Pool)

**Purpose**: 用食材作為防禦盾牌，阻擋敵人進攻

**Constraints**:

- 與攤位配套：3 個 Booth Pool 區域對應 3 個攤位
- Booth Pool 存在條件：總攤位食材 > 0
- Booth Pool 位置：攤位右側（x = 340 開始，寬度 128px）
- Booth Pool 區域大小：128×256 px（與攤位相同）× 3 個垂直排列
- 總耐久度：等於所有攤位食材總數（最大 18）

**Behaviors**:

- **Spawn（生成）**:
  - 攤位獲得第一個食材時，寶箱在攤位前方出現
  - 寶箱耐久度 = 攤位食材數量

- **Sync State（同步狀態）**:
  - 攤位食材增減時，寶箱耐久度同步更新
  - UI 顯示寶箱當前耐久度（等於食材數量）

- **Block Enemy（阻擋敵人）**:
  - 敵人碰撞寶箱時：
    1. 攤位食材 -1
    2. 寶箱耐久度 -1
    3. 敵人立即消失（不掉落食材）

- **Despawn（消失）**:
  - 攤位食材歸零時，寶箱立即消失

**Error Scenarios**:

| 操作         | 當前狀態          | 結果                               |
| ------------ | ----------------- | ---------------------------------- |
| 敵人碰撞寶箱 | 食材 1/6          | 食材歸零，寶箱消失，敵人消失不掉落 |
| 敵人進攻     | 寶箱不存在（0/6） | 敵人進入攤位區，正常偷取食材       |
| 攤位補充食材 | 寶箱已消失        | 新寶箱立即出現                     |
| 玩家觸發合成 | 寶箱存在          | 寶箱耐久度同步減少（食材消耗）     |

**Box System Decision Table**:

| 條件         | 動作     | 結果                       |
| ------------ | -------- | -------------------------- |
| 食材總數 > 0 | 寶箱出現 | 寶箱耐久度 = 食材總數      |
| 食材總數 = 0 | 寶箱消失 | 無寶箱                     |
| 敵人碰撞寶箱 | 阻擋     | 食材-1, 敵人消失（不掉落） |

**Integration with Other Systems**:

- **Booth System**: 寶箱耐久度鏡像攤位食材數量（雙向同步）
- **Combat System**: 敵人碰撞寶箱不計入擊殺數（不觸發掉落）
- **EventQueue**: 訂閱 `FoodStored` 和 `FoodConsumed` 事件更新耐久度

### 2.3.8 Kill Counter System

**Purpose**: 追踪玩家擊殺敵人數量，用於遊戲統計、結算畫面和蚵仔煎消耗

**Constraints**:

- 全局計數器，累積不重置（整場遊戲）
- 無上限，持續累積
- 支援蚵仔煎消耗機制（預設消耗 20 個擊殺數）

**Behaviors**:

- **Count Kill（計數擊殺）**:
  - 敵人被子彈擊殺時，計數器 +1
  - 敵人被寶箱阻擋消失時，計數器不增加
  - 敵人到達底線時，計數器不增加

- **Consume Kills（消耗擊殺數）**:
  - 按鍵 1 觸發蚵仔煎時，檢查擊殺數是否足夠
  - 預設消耗：20 個擊殺數
  - 消耗成功後，擊殺數 -20，啟動蚵仔煎 Buff

- **Visual Feedback（視覺反饋）**:
  - UI 顯示當前擊殺總數（例：15 隻）
  - UI 顯示蚵仔煎可用狀態（例：20/20 可用 或 5/20 不可用）
  - 遊戲結束時在結算畫面顯示總擊殺數

**Kill Counter Decision Table**:

| 條件     | 擊殺數 | 按鍵   | 結果            |
| -------- | ------ | ------ | --------------- |
| 解鎖條件 | ≥20    | 5      | 可觸發          |
| 擊殺不足 | <20    | 5      | 無反應，UI 提示 |
| 觸發消耗 | ≥20    | 5 成功 | 擊殺數 -20      |
| 快吃加成 | 任何   | 5 成功 | 傷害 +10%       |

**Integration with Other Systems**:

- **Combat System**: 訂閱 `EnemyDeath` 事件（僅限子彈擊殺）
- **Synthesis System**: 提供擊殺數查詢和消耗介面
- **Upgrade System**: 快吃升級提升蚵仔煎傷害（+10%）
- **UI System**: 顯示擊殺總數和蚵仔煎可用狀態
- **Game Over Screen**: 顯示最終擊殺統計

### 2.3.9 Audio System

**Purpose**: 管理遊戲音效播放、音量控制、預載入，提供事件驅動的音效反饋

**Constraints**:

- 遊戲啟動時背景預載入所有音效（非阻塞）
- 每個音效 ID 同時只播放一個實例（不重疊播放）
- 音量範圍：0.0 - 1.0（浮點數）
- 音效載入失敗不阻擋遊戲進行（靜默錯誤處理）
- 瀏覽器 Autoplay Policy 阻擋時靜默失敗

**Behaviors**:

- **Preload（預載入）**:
  - 遊戲啟動時背景載入所有音效檔案
  - 使用 Promise.all 並行載入，不阻塞初始化
  - 載入失敗時記錄警告但不拋出錯誤
  - 提供 `isLoaded()` 查詢預載入狀態

- **Play Sound（播放音效）**:
  - 訂閱 `BulletFired`, `EnemyHit`, `ButtonClicked` 事件
  - 事件觸發時播放對應音效
  - 同一音效 ID 若已在播放，停止前一個實例再播放新的
  - 不同音效 ID 可同時播放

- **Volume Control（音量控制）**:
  - 提供 `setVolume(volume: number)` 方法
  - 自動限制範圍 0.0 - 1.0
  - 更新所有已載入音效和播放中音效的音量

- **Lifecycle Management（生命週期管理）**:
  - `initialize()`: 訂閱事件並開始預載入
  - `update()`: 無需每幀更新（事件驅動）
  - `destroy()`: 停止所有播放中音效，清空緩存

**Audio System Decision Table**:

| 音效 ID     | 已載入 | 播放中 | 事件觸發      | 結果                   |
| ----------- | ------ | ------ | ------------- | ---------------------- |
| PlayerShoot | 是     | 否     | BulletFired   | 播放音效               |
| PlayerShoot | 是     | 是     | BulletFired   | 停止前一實例，播放新的 |
| EnemyHit    | 是     | 否     | EnemyHit      | 播放音效               |
| ButtonClick | 是     | 否     | ButtonClicked | 播放音效               |
| 任何        | 否     | 任何   | 任何事件      | 靜默失敗，無音效       |
| 任何        | 是     | 任何   | play() 被阻擋 | 記錄警告，繼續遊戲     |

**Sound ID Mapping**:

| 音效 ID      | 原始檔案路徑                   | Vite 匯入路徑                      | 觸發事件      |
| ------------ | ------------------------------ | ---------------------------------- | ------------- |
| button_click | src/assets/se/select03.mp3     | `import buttonClickSound from ...` | ButtonClicked |
| enemy_hit    | src/assets/se/short_punch1.mp3 | `import enemyHitSound from ...`    | EnemyHit      |
| player_shoot | src/assets/se/shoot5.mp3       | `import playerShootSound from ...` | BulletFired   |

Note: 音效檔案使用 Vite 靜態匯入（與 `src/core/assets.ts` 相同模式），確保正確的資源路徑解析。

**Error Scenarios**:

- 音效檔案不存在：記錄 `console.warn`，遊戲繼續
- 音效載入失敗：`isLoaded()` 回傳 `false`，遊戲繼續
- 瀏覽器阻擋 autoplay：記錄 `console.warn`，遊戲繼續
- 音效尚未載入時嘗試播放：靜默失敗，無錯誤拋出

**Integration with Other Systems**:

- **EventQueue**: 訂閱 `BulletFired`, `EnemyHit`, `ButtonClicked` 事件
- **Combat System**: 發布 `BulletFired` 和 `EnemyHit` 事件
- **Synthesis System**: 按下數字鍵 1-5 時發布 `ButtonClicked` 事件
- **Upgrade Screen**: 點擊升級卡片時發布 `ButtonClicked` 事件
- **System Manager**: 透過依賴注入提供 EventQueue

## 2.4 Player Interactions

### 2.4.1 Input Controls

**鍵盤操作**:

| 按鍵  | 功能     | 行為                                            |
| ----- | -------- | ----------------------------------------------- |
| W     | 向上移動 | 玩家向上移動（200 px/s）                        |
| A     | 向左移動 | 玩家向左移動（200 px/s）                        |
| S     | 向下移動 | 玩家向下移動（200 px/s）                        |
| D     | 向右移動 | 玩家向右移動（200 px/s）                        |
| Space | 射擊     | 發射子彈（消耗彈夾）                            |
| 1     | 夜市總匯 | 消耗豆腐1、珍珠1、米血1，發射連鎖閃電子彈（2s） |
| 2     | 臭豆腐   | 消耗豆腐3，發射貫穿子彈（2s）                   |
| 3     | 珍珠奶茶 | 消耗珍珠3，發射散射子彈（2s）                   |
| 4     | 豬血糕   | 消耗米血3，發射追蹤子彈（2s）                   |
| 5     | 蚵仔煎   | 消耗擊殺數20個，發射百分比傷害子彈（單發）      |

**Input Controls Decision Table**:

| 輸入  | 遊戲狀態 | 彈藥 | Buff | 邊界 | 結果         |
| ----- | -------- | ---- | ---- | ---- | ------------ |
| Space | 進行中   | >0   | 任何 | -    | 發射         |
| Space | 進行中   | 0    | 任何 | -    | 無效果       |
| Space | 重裝中   | 任何 | 任何 | -    | 無效果       |
| 1-5   | 進行中   | 任何 | 無   | -    | 合成嘗試     |
| 1-5   | 進行中   | 任何 | 有   | -    | 無效果       |
| WASD  | 進行中   | 任何 | 任何 | 內部 | 移動 200px/s |
| WASD  | 進行中   | 任何 | 任何 | 邊緣 | 停在邊界     |
| WASD  | 重裝中   | 任何 | 任何 | 任何 | 正常移動     |

### 2.4.2 User Journey

**遊戲開始**:

1. 進入遊戲主畫面
2. 顯示 3 個空攤位（左側 20% 區域）
3. 玩家角色出現在中央
4. 第 1 回合開始（2 隻餓鬼生成）

**回合中**:

1. 敵人從右側畫面外生成
2. 玩家移動並射擊敵人
3. 擊敗敵人掉落食材，食材自動進入對應攤位
4. 按數字鍵 1-5 即時觸發特殊子彈（直接消耗攤位食材）
5. 特殊子彈效果啟動 2 秒
6. 重複 2-5 直到所有敵人清除

**回合結束**:

1. 顯示升級選項（2 選 1）
2. 玩家選擇升級
3. 消耗食材套用升級
4. 進入下一回合

**遊戲結束**:

1. 玩家生命值歸零
2. 顯示存活回合數
3. 顯示擊敗敵人總數
4. 選項：重新開始 / 結束遊戲

## 2.5 Entity Architecture

**Purpose**: 提供統一的遊戲物件基礎架構，用於追蹤和管理所有遊戲內的實體。

### 2.5.1 Entity Base Class

所有遊戲物件（Player、Ghost、Boss、Bullet、Food）繼承自抽象類別 `Entity`。

**Properties**:

- `id: string` - 唯一識別碼（只讀）
- `active: boolean` - 實體是否啟用（用於物件池管理）

**Constraints**:

- ID 必須唯一且不可變更
- ID 生成方式：自增整數轉字串（例：`"1"`, `"2"`, `"3"`）
- 物件池回收時設定 `active = false`，重新啟用時設定 `active = true`

**ID Generation**:

```typescript
// 全域 ID 計數器
let nextEntityId = 1;

// Entity 建構時分配 ID
abstract class Entity {
  public readonly id: string;
  public active: boolean = true;

  constructor() {
    this.id = String(nextEntityId++);
  }
}
```

**Integration with Object Pool**:

- **建立（Create）**：從物件池取得實體時，若池為空則新建 Entity（分配新 ID）
- **啟用（Activate）**：設定 `active = true`，初始化實體狀態
- **停用（Deactivate）**：設定 `active = false`，清除實體狀態，返回物件池
- **銷毀（Destroy）**：物件池清空時，實體永久移除

**Error Scenarios**:

| 操作           | 當前狀態       | 結果         |
| -------------- | -------------- | ------------ |
| 啟用已啟用實體 | active = true  | 無效果       |
| 停用未啟用實體 | active = false | 無效果       |
| 存取已停用實體 | active = false | 應忽略該實體 |

**Benefits**:

- **追蹤性**：所有遊戲物件可透過唯一 ID 識別和除錯
- **物件池整合**：`active` 狀態簡化物件池管理
- **效能**：整數 ID 比 UUID 更高效，適合高頻建立/銷毀場景
- **一致性**：所有遊戲實體使用統一的基礎架構

**測試案例**：參見 [docs/testing.md](docs/testing.md) § 2.8 Entity Tests。

## 2.6 Game Entities

### 2.6.1 Player

**Properties**:

- 移動速度：200 px/s（每秒 200 像素，固定速度）
- 碰撞箱：256×256 px（與視覺大小同步）
- 生命值：5 條（敵人到達底線扣 1 條，無額外血條系統）
- 彈夾容量：6 發
- 當前彈夾數：0-6

**Behaviors**:

- 接收鍵盤輸入移動
- 發射子彈
- 死亡條件：生命值歸零

**測試案例**：參見 [docs/testing.md](docs/testing.md) § 2.6 Player Tests。

### 2.6.2 Enemies

**敵人分類與屬性 Decision Table**:

| 名稱   | 類型        | 敵人分類 | 基礎 HP | 速度 | 掉落物   | 行為 | HP 成長公式             |
| ------ | ----------- | -------- | ------- | ---- | -------- | ---- | ----------------------- |
| 餓鬼   | Ghost       | 小怪     | 1       | 0.5  | **無**   | 直走 | floor(1 + (W-1) × 0.03) |
| 紅餓鬼 | Red Ghost   | 菁英     | 2       | 0.4  | 豆腐     | 直走 | round(2 + (W-1) × 0.6)  |
| 綠餓鬼 | Green Ghost | 菁英     | 2       | 0.4  | 珍珠     | 直走 | round(2 + (W-1) × 0.6)  |
| 藍餓鬼 | Blue Ghost  | 菁英     | 2       | 0.4  | 米血     | 直走 | round(2 + (W-1) × 0.6)  |
| 餓死鬼 | Boss        | Boss     | 10      | 0.3  | 特殊升級 | 直走 | round(10 + (W-5) × 1.5) |
| 餓瘋鬼 | Boss        | Boss     | 10      | 0.3  | 特殊升級 | 斜走 | round(10 + (W-5) × 1.5) |
| 餓幼鬼 | Boss        | Boss     | 6       | 0.7  | 特殊升級 | 直走 | round(6 + (W-5) × 1.0)  |

**HP 成長範例表**:

| 波次 (W) | 餓鬼 | 彩色餓鬼 | 餓死鬼 | 餓瘋鬼 | 餓幼鬼 |
| -------- | ---- | -------- | ------ | ------ | ------ |
| 1        | 1    | 2        | -      | -      | -      |
| 5        | 1    | 4        | 10     | 10     | 6      |
| 10       | 1    | 7        | 18     | 18     | 11     |
| 15       | 1    | 10       | 25     | 25     | 16     |

**敵人分類說明**:

- **小怪（Ghost）**：基礎敵人，生成機率 40%，**不掉落食材**
- **菁英（Elite）**：彩色餓鬼（紅/綠/藍），生成機率各 20%，100% 掉落對應食材
- **Boss**：每 5 波出現一次（波次 5, 10, 15...），擊敗後提供特殊升級選項

**共同行為**:

- 從右側畫面外生成（x = 1950, y = 隨機 214~826，考慮敵人大小確保整個敵人可見）
- 向左移動
- 碰撞攤位時偷取 1 個食材（不改變移動方向）
- 碰撞寶箱時立即消失（不掉落食材）
- 到達底線（x = 340）扣玩家生命並消失
- 被子彈擊中扣除生命值
- 生命值歸零時死亡並掉落食材

**碰撞屬性**:

- 碰撞箱：256×256 px（與視覺大小同步）

**測試案例**：參見 [docs/testing.md](docs/testing.md) § 2.7 Enemy Tests。

### 2.6.3 Bullets

**設計重點**: 透過「極度浮誇」的視覺效果與「毀滅性打擊感」讓玩家直觀感受子彈的強大能量。參考 Vampire Survivors 和 Brotato 的特效風格，所有子彈都具備高辨識度和華麗視覺反饋。

**核心視覺原則**:

- **視覺碰撞統一**: 視覺尺寸與碰撞箱大小相同，確保直覺判定
- **打擊感（Impact）**: 螢幕震動、受擊閃白、爆裂特效
- **粒子華麗度（Particles）**: 大量粒子噴濺（50~200 粒子/次）
- **光影效果（Lighting）**: 高光（Bloom）和發光效果（Glow）
- **毀滅性（Destruction）**: 每發子彈都像具有毀滅性能量的武器
- **尾跡衰減**: 尾跡粒子初始大小與子彈相同，隨時間逐漸縮小並淡出

#### 2.6.3.1 Normal Bullet（普通子彈）

**Properties**:

- 傷害：1
- 速度：400 px/s（向右飛行）
- 穿透：否
- 散射：否
- 尺寸：24×24 px（視覺與碰撞統一）

**Visual Effects**:

| 效果階段 | 視覺效果                                                                | 技術規格                               | 設計意圖                       |
| -------- | ----------------------------------------------------------------------- | -------------------------------------- | ------------------------------ |
| 發射瞬間 | 槍口白色閃光（Muzzle Flash），持續 50ms                                 | 白色光暈，半徑 24px，透明度 80%→0%     | 強調射擊動作                   |
| 飛行中   | 尾端拖著 3 條白色風切線條，線條長度 32px，逐漸消散                      | 粒子數量 3，生命週期 200ms，透明度衰減 | 表示子彈高速飛行               |
| 命中敵人 | **受擊閃白（Hit Flash）**: 敵人精靈閃白 100ms<br>**撞擊特效**: 白色爆裂 | 20 粒子噴濺，速度 100px/s，半徑 16px   | 清晰命中反饋，不搶特殊子彈風采 |

#### 2.6.3.2 Night Market Combo（夜市總匯）

**Properties**（參見 § 2.3.3）:

- 基礎傷害：2
- 效果：連鎖 5 目標，-20%/命中衰減
- 持續時間：2s Buff
- 尺寸：48×48 px（視覺與碰撞統一）

**Visual Effects**:

| 效果階段     | 視覺效果                                                                                                      | 技術規格                                                                | 設計意圖                       |
| ------------ | ------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------- | ------------------------------ |
| 發射瞬間     | 槍口金黃色電流爆發（Electric Burst），持續 100ms                                                              | 金黃色光暈，半徑 48px，透明度 100%→0%，帶有電流粒子 50 個               | 強調「連鎖閃電」能量           |
| 飛行中       | 子彈周圍環繞 5 條金黃色電流螺旋軌跡，電流粒子持續噴發                                                         | 電流粒子 100 個/秒，螺旋半徑 40px，發光效果（Bloom）強度 150%           | 視覺化「連鎖」概念             |
| 子彈 Glow    | 金黃色高光（Bloom）效果，光暈半徑 48px                                                                        | Bloom 強度 200%，顏色 #FFD700（金黃色）                                 | 強調高級感和能量感             |
| 命中第一敵人 | **受擊閃白**: 敵人閃金黃色 150ms<br>**閃電鏈**: 金黃色閃電鏈折射至最近 4 個敵人，每條閃電寬度 4px，持續 300ms | 閃電鏈粒子 200 個，速度 800px/s，閃電路徑帶有扭曲動畫                   | 用「電流」呈現連鎖效果         |
| 連鎖目標     | 被鏈結的敵人全身金光閃爍（300ms），身上爆發金黃色電流粒子                                                     | 每個目標噴發 50 粒子，粒子生命週期 400ms                                | 強調連鎖目標                   |
| 螢幕效果     | **輕微螢幕震動**: 振幅 2px，持續 100ms                                                                        | Screen Shake 強度 2px，頻率 30Hz                                        | 增強打擊感                     |
| 子彈行為     | 命中第一個敵人後不消失，持續連鎖直到目標數達上限或無敵人                                                      | 連鎖邏輯：最近敵人優先，距離限制 400px                                  | 連鎖機制視覺化                 |
| 音效配合     | 電流「滋滋」音效（連續），每次連鎖觸發「啪」音                                                                | 音效疊加，音量隨連鎖次數遞減 10%/次                                     | 聽覺強化連鎖感                 |
| 尾跡特效     | 金黃色電流尾跡，長度 64px，帶有星星閃爍粒子 30 個                                                             | 尾跡粒子生命週期 300ms，透明度 100%→0%                                  | 華麗視覺拖尾                   |
| 最終目標爆炸 | 最後一個連鎖目標爆發金黃色電流爆炸，半徑 64px                                                                 | 爆炸粒子 150 個，速度 200px/s，生命週期 500ms，帶有 Bloom 效果強度 200% | 連鎖終結視覺高潮               |
| 地面殘留     | 命中位置留下金黃色電流灼燒痕跡（持續 1 秒後消散）                                                             | 地面特效尺寸 32×32 px，透明度 80%→0%                                    | 強調能量殘留                   |
| 整體視覺範圍 | 視覺效果範圍 200×200 px，實際判定範圍 16×16 px                                                                | 視覺誇張倍率 12.5x（200/16）                                            | 視覺遠大於判定，營造毀滅性印象 |

#### 2.6.3.3 Stinky Tofu（臭豆腐）

**Properties**（參見 § 2.3.3）:

- 基礎傷害：2
- 效果：貫穿 1 敵人
- 持續時間：2s Buff
- 尺寸：36×36 px（視覺與碰撞統一）

**Visual Effects**:

| 效果階段     | 視覺效果                                                                                          | 技術規格                                             | 設計意圖                   |
| ------------ | ------------------------------------------------------------------------------------------------- | ---------------------------------------------------- | -------------------------- |
| 發射瞬間     | 槍口爆發綠色毒霧（Poison Cloud），持續 150ms                                                      | 綠色霧氣半徑 40px，透明度 90%→0%，粒子 80 個         | 強調「臭豆腐」毒性         |
| 飛行中       | 豆腐後方拖著 5 條波浪狀的綠色氣體尾跡，尾跡長度 80px，氣體粒子持續噴發                            | 氣體粒子 150 個/秒，波浪動畫頻率 10Hz，透明度 70%→0% | 視覺化「臭味」，帶有衝擊感 |
| 子彈 Glow    | 綠色高光（Bloom）效果，光暈半徑 36px                                                              | Bloom 強度 180%，顏色 #00FF00（綠色）                | 強調毒性能量               |
| 貫穿第一敵人 | **受擊閃白**: 敵人閃綠色 120ms<br>**貫穿爆炸**: 敵人背後爆出大團綠色臭氣雲，半徑 80px，持續 500ms | 臭氣雲粒子 200 個，速度 150px/s，帶有毒霧擴散動畫    | 綠色氣體強調「貫穿」力度   |
| 貫穿第二敵人 | 同上，子彈消失前再次觸發貫穿爆炸                                                                  | 第二次爆炸粒子減半（100 個），視覺強度保持           | 貫穿機制視覺化             |
| 螢幕效果     | **輕微螢幕震動**: 振幅 3px，持續 150ms                                                            | Screen Shake 強度 3px，頻率 25Hz                     | 增強貫穿打擊感             |
| 音效配合     | 「噗」音（貫穿瞬間），伴隨低頻震動音效                                                            | 音效分層：高頻「噗」+ 低頻「轟」                     | 聽覺強化貫穿力度           |
| 尾跡粒子數量 | 綠色氣體尾跡粒子密度極高（200 個/秒）                                                             | 粒子大小 8~16px 隨機，生命週期 400ms                 | 華麗尾跡視覺               |
| 地面殘留     | 貫穿位置留下綠色腐蝕痕跡（持續 1.5 秒後消散）                                                     | 地面特效尺寸 48×48 px，透明度 90%→0%，帶有氣泡動畫   | 強調腐蝕性                 |
| 整體視覺範圍 | 視覺效果範圍 160×160 px，實際判定範圍 12×12 px                                                    | 視覺誇張倍率 13.3x（160/12）                         | 視覺遠大於判定             |

#### 2.6.3.4 Bubble Tea（珍珠奶茶）

**Properties**（參見 § 2.3.3）:

- 基礎傷害：1
- 效果：三向散射，+1 子彈
- 持續時間：2s Buff
- 尺寸：48×48 px（每顆，視覺與碰撞統一，巨大黑珍珠）

**Visual Effects**:

| 效果階段     | 視覺效果                                                                                 | 技術規格                                                                     | 設計意圖                       |
| ------------ | ---------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------- | ------------------------------ |
| 發射瞬間     | 槍口爆發黑色珍珠雨（Pearl Rain），三顆巨大黑珍珠同時生成，扇形角度 45°                   | 三顆珍珠尺寸 32×32 px，扇形夾角 45°（-22.5°, 0°, +22.5°），發射速度 400px/s  | 圓潤黑珍珠對比方形豆腐與米血   |
| 飛行中       | 每顆珍珠周圍環繞白色奶茶霧氣粒子，粒子數量 50 個/顆，珍珠帶有反光效果                    | 奶茶霧氣粒子半徑 48px，透明度 60%→0%，珍珠表面高光動畫（Specular Highlight） | 散射軌跡覆蓋範圍大，視覺滿足感 |
| 子彈 Glow    | 黑色珍珠帶有白色光環（Glow），光暈半徑 40px                                              | Bloom 強度 150%，顏色 #FFFFFF（白色）                                        | 強調珍珠奶茶質感               |
| 命中敵人     | **受擊閃白**: 敵人閃白色 100ms<br>**撞擊爆炸**: 白色奶茶液體噴濺，半徑 64px，粒子 120 個 | 液體粒子速度 180px/s，生命週期 400ms，帶有彈跳動畫（Bounce）                 | 液體噴濺強化打擊感             |
| 三顆同時命中 | 若三顆珍珠同時命中同一敵人，觸發**連續受擊閃白**（3 次，間隔 50ms）                      | 閃白疊加效果，敵人精靈顏色 白→正常→白→正常→白→正常                           | 強調多重打擊                   |
| 螢幕效果     | **輕微螢幕震動**: 振幅 1px，持續 80ms（每顆命中）                                        | Screen Shake 強度 1px，若三顆同時命中則振幅 3px                              | 增強打擊感                     |
| 音效配合     | 三顆珍珠發射時「噗噗噗」連續音效，命中時「啪啪啪」撞擊音                                 | 音效時間間隔 50ms，音高略有差異（模擬三顆珍珠）                              | 聽覺強化散射感                 |
| 尾跡特效     | 每顆珍珠拖著白色奶茶霧氣尾跡，長度 48px                                                  | 尾跡粒子 60 個/秒，透明度 70%→0%                                             | 華麗視覺拖尾                   |
| 地面殘留     | 命中位置留下白色奶茶液體痕跡（持續 0.8 秒後消散）                                        | 地面特效尺寸 40×40 px，透明度 80%→0%                                         | 強調液體濺射                   |
| 整體視覺範圍 | 每顆珍珠視覺效果範圍 96×96 px，實際判定範圍 10×10 px，散射覆蓋範圍 300px（扇形夾角 45°） | 視覺誇張倍率 9.6x（96/10）                                                   | 視覺遠大於判定                 |

#### 2.6.3.5 Blood Cake（豬血糕）

**Properties**（參見 § 2.3.3）:

- 基礎傷害：2
- 效果：追蹤，命中-10%敵人移速
- 持續時間：2s Buff
- 尺寸：42×42 px（視覺與碰撞統一）

**Visual Effects**:

| 效果階段     | 視覺效果                                                                                             | 技術規格                                                           | 設計意圖                           |
| ------------ | ---------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------ | ---------------------------------- |
| 發射瞬間     | 槍口爆發黑紅色黏稠液體（Viscous Liquid），持續 120ms                                                 | 黑紅色液體半徑 36px，透明度 90%→0%，粒子 60 個，帶有黏性拉絲動畫   | 強調「黏膩感」                     |
| 飛行中       | 帶有曲線或螺旋軌跡飛向最近的敵人，尾部拖著 7 條黑色黏稠殘影線，線條長度 96px                         | 殘影線透明度 80%→0%，螺旋軌跡半徑 64px，追蹤轉向速度 180°/s        | 強調「黏膩感」呼應緩速效果         |
| 追蹤軌跡     | 非直線飛行，軌跡呈現波浪狀螺旋，追蹤最近敵人（距離限制 600px）                                       | 軌跡粒子 100 個/秒，波浪動畫頻率 8Hz，顏色漸變 黑色→紅色           | 花生粉黃色與黑色糕體對比，易於辨識 |
| 子彈 Glow    | 黑紅色高光（Bloom）效果，光暈半徑 42px                                                               | Bloom 強度 160%，顏色 #8B0000（深紅色）                            | 強調血糕能量                       |
| 命中敵人     | **受擊閃白**: 敵人閃黑紅色 130ms<br>**黏液爆炸**: 黑色黏液噴濺，半徑 72px，粒子 180 個，帶有緩速視覺 | 黏液粒子速度 120px/s（緩慢），生命週期 600ms，粒子帶有重力下墜效果 | 黏液效果強化緩速機制               |
| 緩速視覺     | 被命中敵人身上附著黑色黏液（持續 2 秒），移速 -10%，視覺上敵人移動帶有黏液拖尾                       | 敵人身上黏液粒子 40 個，持續時間 2s，透明度 70%→0%                 | 緩速效果視覺化                     |
| 螢幕效果     | **輕微螢幕震動**: 振幅 2px，持續 100ms                                                               | Screen Shake 強度 2px，頻率 28Hz                                   | 增強打擊感                         |
| 音效配合     | 追蹤飛行時「嗡嗡」低頻音效，命中時「啪嗒」黏液撞擊音                                                 | 音效分層：飛行低頻 + 命中黏液音                                    | 聽覺強化追蹤和黏膩感               |
| 尾跡粒子數量 | 黑色黏稠尾跡粒子密度極高（180 個/秒）                                                                | 粒子大小 10~20px 隨機，生命週期 500ms，帶有拉絲效果                | 華麗尾跡視覺                       |
| 地面殘留     | 命中位置留下黑色血糕痕跡（持續 2 秒後消散）                                                          | 地面特效尺寸 56×56 px，透明度 85%→0%，帶有黏液擴散動畫             | 強調黏稠性                         |
| 整體視覺範圍 | 視覺效果範圍 168×168 px，實際判定範圍 14×14 px                                                       | 視覺誇張倍率 12x（168/14）                                         | 視覺遠大於判定                     |

#### 2.6.3.6 Oyster Omelet（蚵仔煎）- Ultimate

**Properties**（參見 § 2.3.3）:

- 基礎傷害：Boss 10% HP，菁英 50% HP，小怪 70% HP
- 效果：百分比傷害
- 消耗：20 擊殺數（單發）
- 尺寸：192×192 px（視覺與碰撞統一，巨大投擲物）

**Visual Effects**:

| 效果階段     | 視覺效果                                                                                                                             | 技術規格                                                                                       | 設計意圖                             |
| ------------ | ------------------------------------------------------------------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------- | ------------------------------------ |
| 發射瞬間     | 槍口爆發紅色甜辣醬火焰（Sauce Flame），全螢幕閃紅光（Red Flash），持續 200ms                                                         | 紅色火焰半徑 96px，全螢幕閃光透明度 40%→0%，粒子 300 個                                        | 作為大招必須有「重量感」和「毀滅性」 |
| 飛行中       | 巨大的蚵仔煎投擲物沿拋物線軌跡飛行，帶有重力效果，尾部拖著 10 條紅色甜辣醬火焰尾跡，長度 160px                                       | 拋物線重力加速度 400px/s²，尾跡粒子 300 個/秒，火焰動畫持續閃爍                                | 拋物線強調重量感                     |
| 投擲物 Glow  | 紅色高光（Bloom）效果極強，光暈半徑 128px，發光強度隨飛行距離增強                                                                    | Bloom 強度 300%，顏色 #FF0000（紅色），光暈動畫呼吸頻率 5Hz                                    | 強調終極武器能量                     |
| 飛行音效     | 「轟轟轟」持續低頻震動音效，音量隨接近目標增強                                                                                       | 低頻音效 60Hz，音量 50%→100%                                                                   | 聽覺強化重量感                       |
| 命中瞬間     | **全螢幕震動（Screen Shake）**: 振幅 8px，持續 500ms<br>**受擊閃白**: 敵人閃紅白色 300ms<br>**超大爆炸**: 紅色甜辣醬爆炸，半徑 256px | Screen Shake 強度 8px，頻率 20Hz<br>爆炸粒子 500 個，速度 300px/s，生命週期 1s，帶有衝擊波動畫 | 紅色甜辣醬爆炸視覺張力               |
| 爆炸衝擊波   | 紅色圓形衝擊波從命中點向外擴散，半徑 512px，持續 800ms                                                                               | 衝擊波透明度 100%→0%，擴散速度 640px/s，帶有扭曲空氣效果（Heat Distortion）                    | 強調毀滅性衝擊                       |
| 爆炸音效     | 超低頻「轟」爆炸音，伴隨高頻「嗞嗞」蒸發音                                                                                           | 音效分層：低頻 40Hz + 高頻 2000Hz，音量峰值持續 300ms                                          | 聽覺強化爆炸力度                     |
| 光效閃爍     | 爆炸瞬間全螢幕閃紅光 3 次（間隔 100ms），每次透明度 60%→0%                                                                           | 閃光動畫頻率 10Hz，顏色 #FF0000（紅色）                                                        | 強調終極大招視覺高潮                 |
| 地面殘留     | 命中位置留下巨大紅色甜辣醬灼燒痕跡（持續 3 秒後消散）                                                                                | 地面特效尺寸 128×128 px，透明度 100%→0%，帶有火焰殘留動畫                                      | 強調爆炸殘留                         |
| 周圍敵人反應 | 爆炸範圍內所有敵人同時受擊，視覺上同時閃白並噴發紅色粒子                                                                             | 範圍 256px 內所有敵人同步閃白動畫，粒子 80 個/敵人                                             | 強調範圍傷害視覺化                   |
| 尾跡粒子數量 | 紅色火焰尾跡粒子密度極高（300 個/秒），粒子帶有火焰動畫                                                                              | 粒子大小 16~32px 隨機，生命週期 600ms，顏色漸變 紅色→橙色→黃色                                 | 華麗尾跡視覺                         |
| 整體視覺範圍 | 視覺效果範圍 512×512 px（爆炸全範圍），實際判定範圍 32×32 px                                                                         | 視覺誇張倍率 16x（512/32）                                                                     | 視覺遠大於判定，營造毀滅性印象       |
| 攝影機效果   | 命中瞬間短暫畫面凍結（Freeze Frame）100ms，然後爆炸                                                                                  | 時間暫停效果 100ms，增強戲劇性                                                                 | 電影化打擊感                         |

**通用視覺效果規則**:

| 規則類別     | 規格                                    | 適用子彈       |
| ------------ | --------------------------------------- | -------------- |
| 螢幕震動     | 振幅 1~8px，持續 80~500ms，頻率 20~30Hz | 所有特殊子彈   |
| 受擊閃白     | 敵人精靈閃白/特定顏色，持續 100~300ms   | 所有子彈       |
| 粒子數量     | 普通 20~50，特殊 50~200，終極 300~500   | 依子彈類型     |
| Bloom 強度   | 普通 0%，特殊 150~200%，終極 300%       | 特殊子彈和終極 |
| 尾跡粒子數   | 普通 8，特殊 6~14，終極 10              | 所有子彈       |
| 尾跡粒子大小 | 初始大小與子彈相同，隨時間線性縮小至 0  | 所有子彈       |
| 尾跡透明度   | 初始 80%，隨時間線性衰減至 0%           | 所有子彈       |
| 音效分層     | 主音效 + 環境音效（如電流、火焰、黏液） | 特殊子彈       |

**特殊子彈整合**:

各種特殊子彈的遊戲機制效果定義於 § 2.3.3 合成系統的配方表格中。

## 2.7 Visual Layout

### 2.7.1 Screen Resolution

- **目標解析度**：1920×1080 (Full HD)（固定解析度，不支援自適應縮放）
- **寬高比**：16:9
- **視角**：2D 俯視角（Top-Down）

### 2.7.2 Main Scene Layout

**畫面區域分割**:

- 頂部 HUD: 1920×86 px (y: 0 to 86)
- 遊戲區域: 1920×868 px (y: 86 to 954)
  - 攤位區域: 340×868 px (左側)
  - 活動區域: 1580×868 px (右側)
- 底部 HUD: 1920×126 px (y: 954 to 1080)

**攤位區域（左側）**:

- 寬度：340 px（含攤位背景）
- 高度：868 px（遊戲區域全高）
- 背景：image_Stalls.png (340×868)
- 內容：3 個垂直排列的攤位 (128×256 each)

**活動區域（中央到右側）**:

- 寬度：1580 px（1920 - 340）
- 高度：868 px（遊戲區域高）
- 內容：玩家、敵人、子彈、掉落食材

**邊界定義**:

- 左邊界：x = 340（攤位區右側）
- 右邊界：x = 1920（畫面右側）
- 上邊界：y = 86（頂部 HUD 下方）
- 下邊界：y = 954（底部 HUD 上方）
- 底線：x = 340（敵人觸碰此線扣生命）

**實體尺寸**:

- 玩家：256×256 px
- 敵人（Ghost/Boss）：256×256 px
- 攤位：128×256 px
- Box：40×40 px

**實體有效移動範圍**（考慮實體大小，位置為中心點）:

- 玩家/敵人 X 範圍：468~1792 px（340+128 到 1920-128）
- 玩家/敵人 Y 範圍：214~826 px（86+128 到 954-128）

### 2.7.3 HUD Layout

**上方 HUD**:

- 位置：畫面頂部
- 高度：86 px
- 內容：
  - 當前回合數
  - 剩餘敵人數量
  - 玩家生命值（5 條）

**下方 HUD**:

- 位置：畫面底部
- 高度：126 px
- 內容：
  - 可用特殊子彈列表（1-5 數字鍵對應，顯示可用/不可用狀態）
  - 攤位食材庫存提示（豆腐/珍珠/米血數量）
  - 當前特殊子彈效果（Buff 圖示和剩餘時間）
  - 擊殺計數總數（例：15 隻）
  - 彈夾數量（6/6）

**重要約束**:

- HUD 不可遮蓋遊戲活動區域
- HUD 背景需半透明或完全獨立於遊戲畫面

## 2.8 Game States

### 2.8.1 Victory Condition

**不存在勝利條件**（無盡模式）

目標：盡可能存活更多回合

### 2.8.2 Defeat Condition

**觸發條件**:

- 玩家生命值歸零（5 → 4 → 3 → 2 → 1 → 0）

**扣血機制**:

- 敵人（餓鬼或 Boss）到達底線（x = 340）扣 1 條生命
- 敵人消失，玩家生命值 -1

**結束行為**:

1. 遊戲暫停
2. 顯示結算畫面：
   - 存活回合數
   - 擊敗敵人總數
   - 使用特殊子彈次數
3. 提供選項：重新開始 / 結束遊戲

# 3. Consistency Layer

## 3.1 Patterns

**Entity 管理模式**:

所有遊戲物件繼承自 `Entity` 基礎類別：

- 每個實體擁有唯一 ID（自增整數轉字串）
- 使用 `active` 狀態管理物件池生命週期
- 建立時分配 ID，停用時返回物件池，啟用時重新使用

**資源流動模式**:

```
敵人死亡 → 掉落食材 → 自動進入攤位 → 按鍵觸發 → 消耗食材 → 特殊子彈
```

**事件驅動模式**:

遊戲使用 EventQueue 系統統一管理狀態變更和系統間通訊：

- 系統透過 `publish` 發佈事件，透過 `subscribe` 訂閱事件
- 延遲執行透過事件的 `delay` 參數指定（毫秒），由 EventQueue 統一處理
- 系統間解耦：發佈者不直接依賴訂閱者，透過事件類型間接通訊
- 事件流範例：
  ```
  Combat System 發佈 EnemyDeath 事件
    → Booth System 訂閱並儲存掉落食材
    → Wave System 訂閱並更新敵人計數
  ```

**時間驅動模式**:

透過 EventQueue 的延遲執行機制實現：

- 彈夾重裝：發佈 `ReloadComplete` 事件（延遲 3000ms）
- 特殊 Buff：發佈 `BuffExpired` 事件（延遲 2000ms）
- 回合轉換：發佈 `WaveComplete` 事件（延遲可配置，預設立即）
- 敵人移動：持續性移動（速度固定，不使用事件）

**自動觸發模式**:

透過事件訂閱實現自動化行為：

- 食材儲存：Booth System 訂閱 `EnemyDeath` 事件，自動儲存掉落食材
- 合成：Synthesis System 按鍵觸發時發佈 `SynthesisTriggered` 事件
- 重裝：Combat System 檢測到彈夾歸零時發佈 `ReloadComplete` 事件（延遲 3000ms）
- 回合進程：Wave System 檢測到敵人清空時發佈 `WaveComplete` 事件

## 3.2 Forms

**數值格式**:

- 速度：px/s（像素/秒）
- 時間：s（秒）
- 傷害：整數倍率（×1, ×1.2, ×2...）
- 生命值：整數（1, 3, 5）
- 儲存量：整數/最大值（3/6）

**狀態格式**:

- Entity ID：字串格式的整數（`"1"`, `"2"`, `"3"`...）
- Entity 狀態：`active: boolean`（true = 啟用，false = 停用）
- 彈夾：當前數/最大數（3/6）
- 攤位：食材數/容量（4/6）
- 生命值：當前數/最大數（3/5）

### 3.2.1 Vector

**Purpose**: 不可變的 2D 座標值物件，用於遊戲中所有位置和方向計算。

**Design Decisions**:

- **不可變（Immutable）**：所有操作返回新 Vector 實例，防止意外修改
- **浮點座標**：支援精確的方向和速度計算（如散射子彈角度）
- **零向量正規化**：返回 (0, 0) 而非錯誤，優雅降級

**Core Operations**:

| 操作        | 簽章                               | 用途               |
| ----------- | ---------------------------------- | ------------------ |
| `add`       | `add(other: Vector): Vector`       | 向量加法，位置偏移 |
| `subtract`  | `subtract(other: Vector): Vector`  | 向量減法，計算方向 |
| `multiply`  | `multiply(scalar: number): Vector` | 純量乘法，縮放長度 |
| `normalize` | `normalize(): Vector`              | 正規化為單位向量   |
| `magnitude` | `magnitude(): number`              | 計算向量長度       |
| `distance`  | `distance(other: Vector): number`  | 計算兩點距離       |
| `dot`       | `dot(other: Vector): number`       | 點積運算，夾角判斷 |

**Error Handling**:

- 參數為 null/undefined：拋出 TypeError
- 參數為 NaN/Infinity：拋出 TypeError/RangeError
- 零向量正規化：返回 Vector(0, 0)（不拋出錯誤）

**詳細規格**: 參見 [docs/value.md](docs/value.md)

## 3.3 Contracts

**碰撞檢測協議**:

- 玩家與敵人：無效果（玩家不受傷）
- 子彈與敵人：敵人扣血，子彈消失（貫穿子彈除外）
- 敵人與寶箱：食材 -1，寶箱耐久度 -1，敵人消失（不掉落）
- 敵人與攤位：偷取 1 個食材（寶箱不存在時）
- 敵人與底線：扣玩家生命，敵人消失

**Entity 生命週期協議**:

- 所有遊戲物件（Player、Ghost、Boss、Bullet、Food）必須繼承 Entity
- Entity 建構時自動分配唯一 ID
- 物件池管理透過 `active` 狀態切換
- 停用的 Entity（`active = false`）應被系統忽略

**系統間通訊協議**:

所有系統間通訊透過 EventQueue 進行：

- **事件發佈契約**：
  - 發佈者調用 `eventQueue.publish(eventType, data?, delay?)`
  - `eventType` 必須為已定義的事件類型字串（參見 § 2.3.6 Event Types）
  - `data` 為可選的事件資料，型別依事件類型而定
  - `delay` 為可選的延遲時間（毫秒），預設為 0（立即執行）

- **事件訂閱契約**：
  - 訂閱者調用 `eventQueue.subscribe(eventType, handler)`
  - `handler` 簽章：`(data?: any) => void`
  - Handler 必須是冪等的（Idempotent）：重複執行不改變結果
  - Handler 不應拋出未處理的錯誤（錯誤應在內部處理）

- **系統範例**：
  - Combat System 發佈 `EnemyDeath` → Booth System 訂閱並儲存食材
  - Synthesis System 發佈 `SynthesisTriggered` → Combat System 訂閱並啟動 Buff
  - Wave System 發佈 `WaveComplete` → Upgrade System 訂閱並顯示升級選項
  - Combat System 發佈 `ReloadComplete`（延遲 3000ms）→ Combat System 自身訂閱並恢復彈夾

- **直接調用（非事件）**：
  - 合成系統 → 攤位系統：`booth.consumeFood()` 消耗食材（同步操作）
  - 升級系統 → 戰鬥系統：`combat.applyUpgrade()` 永久修改參數（同步操作）

**值物件契約**:

- **Vector**：不可變，所有操作返回新實例
  - 浮點座標支援精確的方向計算
  - 所有數學運算保留浮點精度
  - 操作不修改原實例狀態

# 4. Technical Specifications

## 4.1 Technology Stack

**渲染引擎**:

- **Pixi.js v8.x**：2D WebGL 渲染引擎（唯一支援的渲染引擎）
- **用途**：場景渲染、精靈管理、動畫系統
- **物件池（Object Pool）**：用於管理子彈和敵人（最大池大小：子彈 100 個、敵人 50 個）

**開發工具**:

- **TypeScript**：型別安全的程式語言
- **Vite**：建置工具和開發伺服器
- **Vitest**：單元測試框架

**部署平台**:

- **Cloudflare Pages**：靜態網站託管

## 4.2 Pixi.js Architecture

### 4.2.1 Application Setup

**Canvas 設定**:

```typescript
{
  width: 1920,
  height: 1080,
  backgroundColor: 0x1a1a1a,
  resolution: window.devicePixelRatio || 1,
  autoDensity: true,
  antialias: true
}
```

**目標幀率**：60 FPS（使用 Pixi.Ticker）

### 4.2.2 Scene Structure

**Container 階層**:

```
Application.stage
├── Background Layer (z-index: 0)
│   └── 攤位區域背景
├── Game Layer (z-index: 1)
│   ├── Booth Container
│   │   ├── Booth 1 (珍珠)
│   │   ├── Booth 2 (豆腐)
│   │   └── Booth 3 (米血)
│   ├── Food Drops Container
│   │   └── Food Sprites (動態生成)
│   ├── Player Sprite
│   ├── Enemies Container
│   │   ├── Ghost Sprites (動態生成)
│   │   └── Boss Sprites (動態生成)
│   └── Bullets Container
│       ├── Normal Bullets (動態生成)
│       └── Special Bullets (動態生成)
└── UI Layer (z-index: 2)
    ├── Top HUD Container
    │   ├── Wave Counter Text
    │   ├── Enemy Counter Text
    │   └── Health Display
    └── Bottom HUD Container
        ├── Buff Display
        └── Ammo Counter Text
```

### 4.2.3 Sprite Management

**Texture 資源**:

- 使用 `Pixi.Assets` 載入和管理紋理
- 支援 Sprite Sheet（Texture Atlas）
- 預載入所有遊戲資源

**Sprite Pool**:

- 子彈和敵人使用物件池模式（Object Pool）
- 減少 GC（垃圾回收）壓力
- 最大池大小：子彈 100 個、敵人 50 個

### 4.2.4 Animation System

**動畫類型**:

- **Sprite Animation**：使用 `AnimatedSprite` 播放序列幀動畫
- **Tween Animation**：平滑移動和數值變化（考慮使用 gsap 或自製）
- **Particle Effects**：使用 `@pixi/particle-emitter` 處理特效

**動畫幀率**：

- 角色動畫：12 FPS
- 特效動畫：24 FPS

**子彈視覺效果規格**:

子彈視覺效果的完整定義參見 § 2.6.3 Bullets。以下為技術實作要點：

| 子彈類型 | 粒子密度（個/秒）                      | 關鍵視覺效果                                           | Screen Shake | Bloom 強度 | 技術實作                                                                |
| -------- | -------------------------------------- | ------------------------------------------------------ | ------------ | ---------- | ----------------------------------------------------------------------- |
| 普通子彈 | 3 (尾跡) + 20 (命中)                   | 槍口閃光 + 風切尾跡 + 受擊閃白 + Pop 爆炸              | 無           | 0%         | 簡單粒子發射器 + Sprite 閃白濾鏡                                        |
| 夜市總匯 | 100 (飛行) + 200 (閃電鏈) + 150 (爆炸) | 電流環繞 + 連鎖閃電 + 金光閃爍 + 地面灼燒              | 2px, 100ms   | 200%       | 多目標連線動畫 + Bloom 濾鏡 + 粒子系統 + 受擊閃白                       |
| 臭豆腐   | 150 (飛行) + 200 (貫穿爆炸)            | 毒霧噴發 + 波浪氣體尾跡 + 貫穿臭氣雲 + 地面腐蝕        | 3px, 150ms   | 180%       | 持續性粒子發射 + 波浪動畫 + Bloom 濾鏡 + 貫穿不消失邏輯                 |
| 珍珠奶茶 | 50×3 (每顆飛行) + 120 (每顆命中)       | 珍珠雨扇形發射 + 奶茶霧氣 + 液體噴濺 + 高光反射        | 1px×3, 80ms  | 150%       | 多子彈生成（扇形 45°）+ 粒子系統 + Specular Highlight + Bloom 濾鏡      |
| 豬血糕   | 180 (飛行) + 180 (命中)                | 黏液噴發 + 螺旋追蹤軌跡 + 黏稠殘影 + 緩速視覺          | 2px, 100ms   | 160%       | 追蹤算法（Vector 計算）+ 螺旋軌跡動畫 + 拉絲粒子 + 重力下墜效果 + Bloom |
| 蚵仔煎   | 300 (飛行) + 500 (爆炸)                | 火焰爆發 + 拋物線重力 + 超大爆炸 + 衝擊波 + 全螢幕閃光 | 8px, 500ms   | 300%       | 重力拋物線 + 超強 Screen Shake + 大規模粒子系統 + Bloom 濾鏡 + 時間凍結 |

**核心視覺技術**:

| 技術                         | 用途                   | 參數規格                                           | 適用子彈         |
| ---------------------------- | ---------------------- | -------------------------------------------------- | ---------------- |
| **粒子系統**                 | 尾跡、爆炸、氣體、液體 | 生命週期 200~1000ms，速度 100~300px/s              | 所有子彈         |
| **Bloom 濾鏡**               | 發光效果（Glow）       | 強度 150~300%，半徑 36~128px                       | 特殊子彈         |
| **Screen Shake**             | 螢幕震動               | 振幅 1~8px，持續 80~500ms，頻率 20~30Hz            | 特殊子彈         |
| **受擊閃白（Hit Flash）**    | 敵人被擊中視覺反饋     | 持續 100~300ms，顏色依子彈類型（白/金/綠/紅/黑紅） | 所有子彈         |
| **Sprite 尺寸誇張**          | 視覺尺寸大於判定範圍   | 視覺誇張倍率 1.5~16x                               | 所有子彈         |
| **連線動畫**                 | 閃電鏈、追蹤軌跡       | 寬度 4px，速度 800px/s，帶扭曲動畫                 | 夜市總匯         |
| **拋物線動畫**               | 重力投擲               | 重力加速度 400px/s²，弧形軌跡                      | 蚵仔煎           |
| **地面殘留特效**             | 命中後地面痕跡         | 持續 0.8~3s，透明度漸變                            | 特殊子彈         |
| **全螢幕閃光**               | 終極技能視覺高潮       | 透明度 40~60%，閃爍 1~3 次                         | 蚵仔煎、夜市總匯 |
| **時間凍結（Freeze Frame）** | 命中瞬間畫面暫停       | 持續 100ms                                         | 蚵仔煎           |

**實作優先級（更新）**:

1. **Phase 1（MVP）**：普通子彈基礎視覺（槍口閃光 + 風切尾跡 + Pop + 受擊閃白）
2. **Phase 2（核心特效）**：粒子系統、Bloom 濾鏡、Screen Shake 基礎實作
3. **Phase 3（特殊子彈）**：夜市總匯（連鎖閃電）、臭豆腐（貫穿爆炸）、珍珠奶茶（散射）、豬血糕（追蹤）
4. **Phase 4（終極特效）**：蚵仔煎（超大爆炸 + 衝擊波 + 時間凍結 + 全螢幕閃光）

**效能約束**:

- 粒子系統上限：同時存在 2000 粒子（超過時回收最舊粒子）
- Screen Shake 頻率限制：最多每 50ms 觸發一次（避免過度震動）
- Bloom 濾鏡範圍：最大半徑 128px（避免效能影響）
- 目標 FPS：55~60 FPS（極限負載：50 敵人 + 100 子彈 + 2000 粒子）

### 4.2.5 Collision Detection

**碰撞檢測方式**:

- AABB（Axis-Aligned Bounding Box）矩形碰撞
- 每幀檢查所有活躍實體

**碰撞組合**:

| 物件 A | 物件 B | 檢測方式       | 回應               |
| ------ | ------ | -------------- | ------------------ |
| 子彈   | 敵人   | AABB           | 敵人扣血，子彈消失 |
| 敵人   | 攤位   | AABB           | 偷取食材           |
| 敵人   | 底線   | X 座標檢查     | 扣玩家生命         |
| 玩家   | 敵人   | 無碰撞（穿透） | 無效果             |
| 玩家   | 邊界   | 邊界座標限制   | 停止移動           |

### 4.2.6 Performance Optimization

**渲染優化**:

- 使用 `ParticleContainer` 處理大量相似物件（子彈、小型敵人）
- 關閉不需要的互動性（`interactive = false`）
- 使用 `cacheAsBitmap` 快取靜態元素（攤位、HUD 背景）

**記憶體管理**:

- 銷毀不再使用的紋理和精靈
- 使用物件池減少物件建立/銷毀
- 定期清理 Ticker 監聽器

**目標效能**:

- 60 FPS（16.67ms per frame）
- 50 隻敵人 + 100 發子彈同時存在
- 記憶體使用 < 200 MB

## 4.3 Browser Compatibility

**目標瀏覽器**：

- Chrome 120+
- Firefox 120+
- Safari 17+

**不支援**：

- Internet Explorer
- 行動裝置瀏覽器（此版本僅支援桌面）

**必需功能**:

- WebGL 2.0 支援
- ES2020+ 語法支援
- Keyboard API

## 4.4 Asset Requirements

**紋理格式**:

- PNG（支援透明）
- 建議使用 Sprite Sheet 減少 HTTP 請求

**音效格式**:

- MP3 或 WebM（跨瀏覽器相容）
- 背景音樂：循環播放，檔案大小 < 2 MB
- 音效：短促，檔案大小 < 100 KB

**總資產大小**:

- 目標：< 10 MB
- 上限：< 25 MB（Cloudflare Pages 限制）

## 4.5 Deployment

**建置流程**:

1. TypeScript 編譯
2. Vite 打包（生產模式）
3. 資產最佳化（壓縮圖片、音效）
4. 部署至 Cloudflare Pages

**環境變數**:

- `VITE_VERSION`：遊戲版本號
- `VITE_ENVIRONMENT`：development / production

**Cloudflare Pages 設定**:

- 建置指令：`npm run build`
- 輸出目錄：`dist`
- Node 版本：18.x

# 5. Appendix

## 5.1 Open Questions

**待澄清的設計細節**:

1. 玩家角色視覺設計（大小、外觀）
2. 敵人生成位置（右側畫面外多遠？）
3. 食材掉落位置（敵人死亡位置？隨機偏移？）
4. 子彈飛行距離上限（穿透類子彈何時消失？）
5. 夜市總匯閃電跳躍距離（多遠內的敵人可被連鎖？）
6. 升級選項池大小（是否只有 3 種升級？）
7. 音效和背景音樂規格
8. 視覺風格（像素風、手繪風、3D 渲染？）
9. 敵人生成間隔（同時生成還是逐個生成？）
10. 合成失敗提示（食材不足時的 UI 反饋）
11. Sprite Sheet 規格（每個精靈的尺寸和佈局）
12. 粒子特效細節（爆炸、拾取、合成特效）
